<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –æ—Ä—É–∂–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .test-button {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 2px solid #555;
            padding: 10px 20px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .test-button:hover {
            background: #3a3a3a;
            border-color: #8B4513;
        }

        .status {
            background: #2a2a2a;
            border: 1px solid #555;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .weapon-info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }

        /* Weapon dropdown styles for testing */
        .weapon-slot {
            position: relative;
            background: #1a1a1a;
            border: 2px solid #444;
            padding: 15px 8px;
            text-align: center;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weapon-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .weapon-icon {
            width: 64px;
            height: 32px;
            object-fit: contain;
            image-rendering: pixelated;
        }

        /* Specific weapon sizes for main display */
        .weapon-slot[data-current-weapon="pistol"] .weapon-icon {
            width: 32px;
            height: 32px;
        }

        .weapon-slot[data-current-weapon="shotgun"] .weapon-icon {
            width: 96px;
            height: 32px;
        }

        .weapon-slot[data-current-weapon="assault_rifle"] .weapon-icon {
            width: 96px;
            height: 32px;
        }

        .weapon-slot[data-current-weapon="sniper_rifle"] .weapon-icon {
            width: 128px;
            height: 32px;
        }

        .weapon-name {
            font-size: 10px;
            color: #e0e0e0;
            text-align: center;
        }

        .weapon-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border: 2px solid #8B4513;
            border-radius: 4px;
            z-index: 25000;
            display: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .weapon-dropdown.show {
            display: block;
        }

        .weapon-option {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #444;
            min-height: 60px;
            position: relative;
        }

        .weapon-option:last-child {
            border-bottom: none;
        }

        .weapon-option:hover:not(.locked) {
            background: #2a2a2a;
        }

        .weapon-option.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .weapon-option.locked::after {
            content: 'üîí';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            color: #f44336;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .weapon-option-icon {
            object-fit: contain;
            image-rendering: pixelated;
            max-width: 100%;
            max-height: 40px;
        }

        /* Specific weapon sizes in dropdown */
        .weapon-option[data-weapon="pistol"] .weapon-option-icon {
            width: 32px;
            height: 32px;
        }

        .weapon-option[data-weapon="shotgun"] .weapon-option-icon {
            width: 96px;
            height: 32px;
        }

        .weapon-option[data-weapon="assault_rifle"] .weapon-option-icon {
            width: 96px;
            height: 32px;
        }

        .weapon-option[data-weapon="sniper_rifle"] .weapon-option-icon {
            width: 128px;
            height: 32px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –æ—Ä—É–∂–∏—è</h1>

        <div class="status">
            <h3>–¢–µ–∫—É—â–µ–µ –æ—Ä—É–∂–∏–µ: <span id="current-weapon">–ü–∏—Å—Ç–æ–ª–µ—Ç</span></h3>
            <p>–°—Ç–∞—Ç—É—Å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π:</p>
            <ul>
                <li>–î—Ä–æ–±–æ–≤–∏–∫: <span id="shotgun-status">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span></li>
                <li>–®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞: <span id="assault-rifle-status">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞</span></li>
                <li>–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞: <span id="sniper-rifle-status">üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞</span></li>
            </ul>
        </div>

        <!-- Test Weapon Slot -->
        <div class="weapon-slot" data-current-weapon="pistol" onclick="window.toggleWeaponDropdown()">
            <div class="weapon-display">
                <img src="src/sprites/guns/img/pistol.png" alt="–ü–∏—Å—Ç–æ–ª–µ—Ç" class="weapon-icon" id="current-weapon-icon">
                <div class="weapon-name" id="current-weapon-name">–ü–∏—Å—Ç–æ–ª–µ—Ç</div>
            </div>
            <div class="weapon-dropdown" id="weapon-dropdown">
                <div class="weapon-option" data-weapon="pistol" onclick="window.selectWeapon('pistol')">
                    <img src="src/sprites/guns/img/pistol.png" alt="–ü–∏—Å—Ç–æ–ª–µ—Ç" class="weapon-option-icon">
                </div>
                <div class="weapon-option locked" data-weapon="shotgun" onclick="window.selectWeapon('shotgun')">
                    <img src="src/sprites/guns/img/shotgun.png" alt="–î—Ä–æ–±–æ–≤–∏–∫" class="weapon-option-icon">
                </div>
                <div class="weapon-option locked" data-weapon="assault_rifle" onclick="window.selectWeapon('assault_rifle')">
                    <img src="src/sprites/guns/img/assault_rifle.png" alt="–®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞" class="weapon-option-icon">
                </div>
                <div class="weapon-option locked" data-weapon="sniper_rifle" onclick="window.selectWeapon('sniper_rifle')">
                    <img src="src/sprites/guns/img/sniper_rifle.png" alt="–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞" class="weapon-option-icon">
                </div>
            </div>
        </div>

        <div class="test-buttons">
            <button class="test-button" onclick="learnShotgun()">–ò–∑—É—á–∏—Ç—å –¥—Ä–æ–±–æ–≤–∏–∫</button>
            <button class="test-button" onclick="learnAssaultRifle()">–ò–∑—É—á–∏—Ç—å —à—Ç—É—Ä–º–æ–≤—É—é –≤–∏–Ω—Ç–æ–≤–∫—É</button>
            <button class="test-button" onclick="learnSniperRifle()">–ò–∑—É—á–∏—Ç—å —Å–Ω–∞–π–ø–µ—Ä—Å–∫—É—é –≤–∏–Ω—Ç–æ–≤–∫—É</button>
            <button class="test-button" onclick="resetAbilities()">–°–±—Ä–æ—Å–∏—Ç—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</button>
            <button class="test-button" onclick="window.initializeWeaponSystem()">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
        </div>

        <div class="weapon-info">
            <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ä—É–∂–∏–∏:</h3>
            <p><strong>–ü–∏—Å—Ç–æ–ª–µ—Ç:</strong> –£—Ä–æ–Ω: 1, –†–∞–∑–º–µ—Ä: 64x32</p>
            <p><strong>–î—Ä–æ–±–æ–≤–∏–∫:</strong> –£—Ä–æ–Ω: 2, –†–∞–∑–º–µ—Ä: 160x32</p>
            <p><strong>–®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞:</strong> –£—Ä–æ–Ω: 1, –†–∞–∑–º–µ—Ä: 128x48</p>
            <p><strong>–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞:</strong> –£—Ä–æ–Ω: 3, –†–∞–∑–º–µ—Ä: 160x32</p>
        </div>
    </div>

    <script>
        // Mock abilities data for testing
        let mockAbilitiesData = {
            abilitiesData: {
                defense: [
                    {
                        id: 'def_shotgun',
                        name: '–î—Ä–æ–±–æ–≤–∏–∫',
                        currentLevel: 0
                    },
                    {
                        id: 'def_assault_rifle',
                        name: '–®—Ç—É—Ä–º',
                        currentLevel: 0
                    },
                    {
                        id: 'def_sniper_rifle',
                        name: '–°–Ω–∞–π–ø–µ—Ä',
                        currentLevel: 0
                    }
                ]
            }
        };

        // Mock getAbilitiesData function
        window.getAbilitiesData = function() {
            return mockAbilitiesData;
        };

        // Mock showToast function
        window.showToast = function(message) {
            console.log('Toast:', message);
            alert(message);
        };

        // Initialize weapon system functions (copy from main file)
        window.currentWeapon = 'pistol';
        window.weaponDropdownVisible = false;

        window.toggleWeaponDropdown = function() {
            const dropdown = document.getElementById('weapon-dropdown');
            if (dropdown) {
                window.weaponDropdownVisible = !window.weaponDropdownVisible;
                if (window.weaponDropdownVisible) {
                    dropdown.classList.add('show');
                    if (window.updateWeaponAvailability) window.updateWeaponAvailability();
                } else {
                    dropdown.classList.remove('show');
                }
            }
        };

        window.selectWeapon = function(weaponType) {
            if (window.isWeaponAvailable && !window.isWeaponAvailable(weaponType)) {
                if (window.showToast) window.showToast('–≠—Ç–æ –æ—Ä—É–∂–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑—É—á–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏!');
                return;
            }

            window.currentWeapon = weaponType;
            if (window.updateWeaponDisplay) window.updateWeaponDisplay(weaponType);
            window.weaponDropdownVisible = false;
            const dropdown = document.getElementById('weapon-dropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
            }

            if (window.showToast) window.showToast(`–í—ã–±—Ä–∞–Ω–æ –æ—Ä—É–∂–∏–µ: ${window.getWeaponDisplayName ? window.getWeaponDisplayName(weaponType) : weaponType}`);
        };

        window.getWeaponData = function(weaponType) {
            const weapons = {
                pistol: {
                    name: '–ü–∏—Å—Ç–æ–ª–µ—Ç',
                    icon: 'src/sprites/guns/img/pistol.png',
                    damage: 1,
                    ammoType: 'pistol'
                },
                shotgun: {
                    name: '–î—Ä–æ–±–æ–≤–∏–∫',
                    icon: 'src/sprites/guns/img/shotgun.png',
                    damage: 2,
                    ammoType: 'shotgun'
                },
                assault_rifle: {
                    name: '–®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞',
                    icon: 'src/sprites/guns/img/assault_rifle.png',
                    damage: 1,
                    ammoType: 'assault_rifle'
                },
                sniper_rifle: {
                    name: '–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞',
                    icon: 'src/sprites/guns/img/sniper_rifle.png',
                    damage: 3,
                    ammoType: 'sniper_rifle'
                }
            };

            return weapons[weaponType] || weapons.pistol;
        };

        window.getWeaponDisplayName = function(weaponType) {
            const weaponData = window.getWeaponData(weaponType);
            return weaponData.name;
        };

        window.isWeaponAvailable = function(weaponType) {
            if (weaponType === 'pistol') return true;

            if (typeof window.getAbilitiesData === 'function') {
                try {
                    const abilitiesData = window.getAbilitiesData();
                    if (abilitiesData && abilitiesData.abilitiesData) {
                        const defenseAbilities = abilitiesData.abilitiesData.defense;
                        if (Array.isArray(defenseAbilities)) {
                            switch (weaponType) {
                                case 'shotgun':
                                    const shotgunAbility = defenseAbilities.find(ability => ability.id === 'def_shotgun');
                                    return shotgunAbility && shotgunAbility.currentLevel > 0;
                                case 'assault_rifle':
                                    const assaultRifleAbility = defenseAbilities.find(ability => ability.id === 'def_assault_rifle');
                                    return assaultRifleAbility && assaultRifleAbility.currentLevel > 0;
                                case 'sniper_rifle':
                                    const sniperRifleAbility = defenseAbilities.find(ability => ability.id === 'def_sniper_rifle');
                                    return sniperRifleAbility && sniperRifleAbility.currentLevel > 0;
                                default:
                                    return false;
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Error checking weapon availability:', error);
                }
            }

            return false;
        };

        window.updateWeaponDisplay = function(weaponType) {
            const icon = document.getElementById('current-weapon-icon');
            const name = document.getElementById('current-weapon-name');
            const weaponSlot = document.querySelector('.weapon-slot');

            if (icon && name && weaponSlot) {
                const weaponData = window.getWeaponData(weaponType);
                icon.src = weaponData.icon;
                icon.alt = weaponData.name;
                name.textContent = weaponData.name;
                weaponSlot.setAttribute('data-current-weapon', weaponType);
            }
        };

        window.updateWeaponAvailability = function() {
            const weaponOptions = document.querySelectorAll('.weapon-option');

            weaponOptions.forEach(option => {
                const weaponType = option.dataset.weapon;
                const isAvailable = window.isWeaponAvailable(weaponType);

                if (isAvailable) {
                    option.classList.remove('locked');
                    const status = option.querySelector('.weapon-option-status');
                    if (status) {
                        status.textContent = '‚úì';
                        status.className = 'weapon-option-status available';
                    }
                } else {
                    option.classList.add('locked');
                    const status = option.querySelector('.weapon-option-status');
                    if (status) {
                        status.textContent = 'üîí';
                        status.className = 'weapon-option-status locked';
                    }
                }
            });
        };

        window.initializeWeaponSystem = function() {
            window.updateWeaponDisplay(window.currentWeapon);
            window.updateWeaponAvailability();
        };

        // Test functions
        function learnShotgun() {
            mockAbilitiesData.abilitiesData.defense[0].currentLevel = 1;
            updateStatus();
            window.initializeWeaponSystem();
            window.showToast('–ò–∑—É—á–µ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –î—Ä–æ–±–æ–≤–∏–∫');
        }

        function learnAssaultRifle() {
            mockAbilitiesData.abilitiesData.defense[1].currentLevel = 1;
            updateStatus();
            window.initializeWeaponSystem();
            window.showToast('–ò–∑—É—á–µ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –®—Ç—É—Ä–º');
        }

        function learnSniperRifle() {
            mockAbilitiesData.abilitiesData.defense[2].currentLevel = 1;
            updateStatus();
            window.initializeWeaponSystem();
            window.showToast('–ò–∑—É—á–µ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –°–Ω–∞–π–ø–µ—Ä');
        }

        function resetAbilities() {
            mockAbilitiesData.abilitiesData.defense.forEach(ability => {
                ability.currentLevel = 0;
            });
            updateStatus();
            window.initializeWeaponSystem();
            window.showToast('–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–±—Ä–æ—à–µ–Ω—ã');
        }

        function updateStatus() {
            const shotgunStatus = document.getElementById('shotgun-status');
            const assaultRifleStatus = document.getElementById('assault-rifle-status');
            const sniperRifleStatus = document.getElementById('sniper-rifle-status');

            if (mockAbilitiesData.abilitiesData.defense[0].currentLevel > 0) {
                shotgunStatus.textContent = '‚úì –î–æ—Å—Ç—É–ø–µ–Ω';
                shotgunStatus.style.color = '#4CAF50';
            } else {
                shotgunStatus.textContent = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                shotgunStatus.style.color = '#f44336';
            }

            if (mockAbilitiesData.abilitiesData.defense[1].currentLevel > 0) {
                assaultRifleStatus.textContent = '‚úì –î–æ—Å—Ç—É–ø–Ω–∞';
                assaultRifleStatus.style.color = '#4CAF50';
            } else {
                assaultRifleStatus.textContent = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞';
                assaultRifleStatus.style.color = '#f44336';
            }

            if (mockAbilitiesData.abilitiesData.defense[2].currentLevel > 0) {
                sniperRifleStatus.textContent = '‚úì –î–æ—Å—Ç—É–ø–Ω–∞';
                sniperRifleStatus.style.color = '#4CAF50';
            } else {
                sniperRifleStatus.textContent = 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞';
                sniperRifleStatus.style.color = '#f44336';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            window.initializeWeaponSystem();
        });
    </script>
</body>
</html>
