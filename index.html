<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Bunker Survivors</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
      html, body { height: 100%; margin: 0; background:#111; overflow: hidden; }
      #game {
        width: 100vw;
        height: var(--app-vh, 100dvh);
        display:flex;
      }
      canvas { display:block; margin:auto; image-rendering: pixelated; image-rendering: crisp-edges; }
    </style>
  </head>
  <body>
    <div id="game"></div>

    <!-- Game UI Overlay Container -->
    <div id="game-ui-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: auto; z-index: 10000; pointer-events: none;"></div>

    <script type="module" src="/src/main.ts"></script>
    <script type="module" src="/src/ui/ui-manager.js"></script>
  </body>
  <script>
    // Mobile viewport height fix (fallback for browsers without 100dvh)
    function setAppVh() {
      document.documentElement.style.setProperty('--app-vh', window.innerHeight + 'px')
    }
    setAppVh()
    window.addEventListener('resize', setAppVh)
    window.addEventListener('orientationchange', setAppVh)

    // Prevent passive pinch-zoom scroll issues on mobile
    document.addEventListener('gesturestart', function (e) { e.preventDefault() }, { passive: false })
  </script>

  <!-- Global UI functions for HTML overlay -->
  <script>
    // Global functions for UI overlay button clicks
    window.openInventory = function() {
      // Populate inventory and open modal
      if (typeof populateInventoryModal === 'function') {
        populateInventoryModal(null); // Will use sample data
      }
      openModal('inventory-modal');
    };

    window.openAbilities = function() {
      // Populate abilities and open modal
      if (typeof populateAbilitiesModal === 'function') {
        populateAbilitiesModal(null); // Will use sample data
      }
      openModal('abilities-modal');
    };

    window.openRoomSelection = function() {
      // Populate room selection and open modal
      if (typeof populateRoomSelectionModal === 'function') {
        // –ü–æ–ª—É—á–∞–µ–º GameScene –∏–∑ window.game
        let gameScene = null;
        if (window.game && window.game.scene) {
          console.log('[HTML] Available scenes:', window.game.scene.scenes.map(s => s.scene.key));
          
          // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω —Å—Ü–µ–Ω—ã
          gameScene = window.game.scene.getScene('GameScene') || 
                     window.game.scene.getScene('Game');
          
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é —Å—Ü–µ–Ω—É Game
          if (!gameScene) {
            const gameScenes = window.game.scene.scenes.filter(s => s.scene.key === 'Game');
            if (gameScenes.length > 0) {
              gameScene = gameScenes[0];
            }
          }
          
          console.log('[HTML] Found gameScene:', !!gameScene);
        }
        populateRoomSelectionModal(gameScene);
      }
      openModal('room-selection-modal');
    };

    window.togglePause = function() {
      // Open menu modal instead of just pausing
      openModal('menu-modal');
    };

    window.openResidents = function() {
      console.log('=== OPENING RESIDENTS MODAL ===');
      console.log('window.game exists:', !!window.game);
      console.log('window.game.scene exists:', !!(window.game && window.game.scene));

      // Get real data from game scene
      let residents = [];
      if (window.game && window.game.scene) {
        try {
          const gameScene = window.game.scene.getScene('Game');
          console.log('Game scene found:', !!gameScene);

          if (gameScene) {
            // Try to use the new method first
            if (typeof gameScene.getCurrentResidentsData === 'function') {
              residents = gameScene.getCurrentResidentsData();
              console.log('Got residents using getCurrentResidentsData method');
            } else {
              // Fallback to manual data collection
              const rawResidents = gameScene.bunkerResidents || [];
              console.log('Raw residents from game:', rawResidents);
              console.log('Raw residents count:', rawResidents.length);

              residents = rawResidents.map((resident, index) => ({
                id: resident.id,
                index: index,
                name: resident.name,
                age: resident.age,
                gender: resident.gender,
                profession: resident.profession,
                status: resident.status || '–û—Ç–¥—ã—Ö–∞–µ—Ç',
                hunger: resident.hunger || 100,
                thirst: resident.thirst || 100,
                energy: resident.energy || 100,
                health: resident.health || 100,
                skills: resident.skills || [],
                itemsText: resident.itemsText || '–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤',
                admittedAt: resident.admittedAt,
                patient: resident.patient || false,
                isEnemy: false
              }));

              console.log('Formatted residents count:', residents.length);
            }

            if (residents.length > 0) {
              console.log('First resident sample:', residents[0]);
            } else {
              console.warn('No residents found in bunker');
            }
          } else {
            console.error('Game scene not found!');
          }
        } catch (error) {
          console.error('Error getting residents data:', error);
        }
      } else {
        console.warn('window.game or window.game.scene not available');
        console.log('Available window properties:', Object.keys(window).filter(k => k.includes('game')));
      }

      // Store residents data globally for detail view
      window.currentResidentsData = residents;
      console.log('Stored residents data count:', residents.length);

      // If no residents found, try to get them from bunkerView
      if (residents.length === 0 && window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.simpleBunker) {
          console.log('Trying to get residents from bunkerView...');
          // Some residents might be managed by bunkerView
        }
      }

      // Populate modal with data
      if (typeof window.populatePopulationModal === 'function') {
        console.log('Calling populatePopulationModal with', residents.length, 'residents');
        window.populatePopulationModal(residents);
      } else {
        console.error('populatePopulationModal function not found');
      }

      // Open modal
      if (typeof window.openModal === 'function') {
        console.log('Opening population-modal');
        window.openModal('population-modal');
      } else {
        console.error('openModal function not found');
      }

      console.log('=== RESIDENTS MODAL OPENING COMPLETE ===');
    };

    window.openResource = function(resource) {
      console.log('Opening resource modal:', resource);

      // Get resource data from game or use defaults
      let gameData = {
        happiness: 50,
        defense: 50,
        ammo: 100,
        comfort: 100,
        food: 100,
        water: 100,
        money: 200,
        population: 0
      };

      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          gameData = {
            happiness: gameScene.happiness || 50,
            defense: gameScene.defense || 50,
            ammo: gameScene.ammo || 100,
            comfort: gameScene.comfort || 100,
            food: gameScene.food || 100,
            water: gameScene.water || 100,
            money: gameScene.money || 200,
            population: gameScene.bunkerResidents ? gameScene.bunkerResidents.length : 0
          };
        }
      }

      // Populate modal with data
      if (typeof window.populateResourceModal === 'function') {
        window.populateResourceModal(resource, gameData);
      }

      // Open modal
      if (typeof window.openModal === 'function') {
        window.openModal('resource-modal');
      }
    };

    window.openEnemies = function() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          const enemyCount = gameScene.bunkerEnemies ? gameScene.bunkerEnemies.length : 0;
          gameScene.showToast(`Enemies: ${enemyCount}`);
        }
      }
    };

    // Modal management functions
    window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';
        
        // Special handling for abilities modal
        if (modalId === 'abilities-modal') {
          clearAbilityTree();
        }
      }
    };

    window.openModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'block';
      }
    };

    // Population modal functions
    window.populatePopulationModal = function(residents) {
      const container = document.getElementById('population-list');
      if (!container) return;

      container.innerHTML = '';

      if (residents && residents.length > 0) {
        residents.forEach((resident, index) => {
          const residentDiv = document.createElement('div');
          residentDiv.className = 'resident-item';
          residentDiv.onclick = () => openResidentDetail(index);
          residentDiv.style.cursor = 'pointer';
          residentDiv.style.transition = 'all 0.2s ease';

          // Add hover effect
          residentDiv.onmouseover = () => {
            residentDiv.style.background = '#3a3a3a';
            residentDiv.style.borderColor = '#D4AF37';
          };
          residentDiv.onmouseout = () => {
            residentDiv.style.background = '#2a2a2a';
            residentDiv.style.borderColor = '#555555';
          };

          residentDiv.innerHTML = `
            <div class="resident-info">
              <div class="resident-name">${resident.name}</div>
              <div class="resident-profession">${resident.profession}</div>
            </div>
          `;

          container.appendChild(residentDiv);
        });
      } else {
        container.innerHTML = '<p style="text-align: center; color: #888;">–í –±—É–Ω–∫–µ—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç –∂–∏—Ç–µ–ª–µ–π</p>';
      }
    };

    window.openResidentDetail = function(index) {
      console.log('Opening resident detail for index:', index);

      // Get resident data from stored residents
      let resident = window.currentResidentsData ? window.currentResidentsData[index] : null;

      if (!resident) {
        console.error('Resident not found at index:', index);
        return;
      }

      // Sync with real-time data from Phaser
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          // Try to get fresh data using the new method
          if (typeof gameScene.getResidentById === 'function') {
            const freshData = gameScene.getResidentById(resident.id);
            if (freshData) {
              console.log('Got fresh data for resident:', freshData.name, 'health:', freshData.health);
              resident = { ...resident, ...freshData };
            }
          } else {
            // Fallback to manual sync
            if (gameScene.simpleBunker && gameScene.simpleBunker.residentAgents) {
              const agent = gameScene.simpleBunker.residentAgents.find(a => a.id === resident.id);
              if (agent && agent.health !== undefined) {
                console.log('Syncing health from bunkerView:', agent.health, 'for resident:', resident.name);
                resident.health = agent.health;
              }
            }

            // Also check if resident has updated data in bunkerResidents
            const updatedResident = gameScene.bunkerResidents.find(r => r.id === resident.id);
            if (updatedResident) {
              resident.hunger = updatedResident.hunger || 100;
              resident.thirst = updatedResident.thirst || 100;
              resident.energy = updatedResident.energy || 100;
              resident.health = updatedResident.health || 100;
              resident.status = updatedResident.status || '–û—Ç–¥—ã—Ö–∞–µ—Ç';
            }
          }
        }
      }

      console.log('Showing details for resident:', resident.name, 'health:', resident.health);

      // Populate resident detail modal
      if (typeof window.populateResidentDetailModal === 'function') {
        window.populateResidentDetailModal(resident);
      }

      // Open resident detail modal
      if (typeof window.openModal === 'function') {
        window.openModal('resident-detail-modal');
      }
    };

    // Resident detail modal functions
    window.populateResidentDetailModal = function(resident) {
      const container = document.getElementById('resident-detail-content');
      if (!container) return;

      // Format skills
      const skillsList = resident.skills && resident.skills.length > 0
        ? resident.skills.map(skill =>
            `<div class="skill-item ${skill.positive ? 'positive' : 'negative'}">
              <span class="skill-text">${skill.text}</span>
              <span class="skill-effect">${skill.positive ? '‚úì' : '‚úó'}</span>
            </div>`
          ).join('')
        : '<div class="no-skills">–ù–µ—Ç –Ω–∞–≤—ã–∫–æ–≤</div>';

      // Create resident detail HTML
      container.innerHTML = `
        <div class="resident-details">
          <div class="detail-section main-info">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="label">–ò–º—è:</span>
                <span class="value">${resident.name}</span>
              </div>
              <div class="detail-item">
                <span class="label">–í–æ–∑—Ä–∞—Å—Ç:</span>
                <span class="value">${resident.age} –ª–µ—Ç</span>
              </div>
              <div class="detail-item">
                <span class="label">–ü–æ–ª:</span>
                <span class="value">${resident.gender === '–ú' ? '–ú—É–∂—Å–∫–æ–π' : '–ñ–µ–Ω—Å–∫–∏–π'}</span>
              </div>
              <div class="detail-item">
                <span class="label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</span>
                <span class="value">${resident.profession}</span>
              </div>
              <div class="detail-item">
                <span class="label">–°—Ç–∞—Ç—É—Å:</span>
                <span class="value">${resident.status}</span>
              </div>
              <div class="detail-item">
                <span class="label">–í –±—É–Ω–∫–µ—Ä–µ —Å:</span>
                <span class="value">–î–µ–Ω—å ${resident.admittedAt || 1}</span>
              </div>
            </div>
          </div>

          <div class="detail-section status-info">
            <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
            <div class="status-meters">
              <div class="status-meter">
                <div class="meter-label">–ì–æ–ª–æ–¥</div>
                <div class="meter-bar">
                  <div class="meter-fill hunger" style="width: ${resident.hunger}%"></div>
                </div>
                <span class="meter-value">${Math.round(resident.hunger)}%</span>
              </div>
              <div class="status-meter">
                <div class="meter-label">–ñ–∞–∂–¥–∞</div>
                <div class="meter-bar">
                  <div class="meter-fill thirst" style="width: ${resident.thirst}%"></div>
                </div>
                <span class="meter-value">${Math.round(resident.thirst)}%</span>
              </div>
              <div class="status-meter">
                <div class="meter-label">–≠–Ω–µ—Ä–≥–∏—è</div>
                <div class="meter-bar">
                  <div class="meter-fill energy" style="width: ${resident.energy}%"></div>
                </div>
                <span class="meter-value">${Math.round(resident.energy)}%</span>
              </div>
              <div class="status-meter">
                <div class="meter-label">–ó–¥–æ—Ä–æ–≤—å–µ</div>
                <div class="meter-bar">
                  <div class="meter-fill health" style="width: ${resident.health}%"></div>
                </div>
                <span class="meter-value">${Math.round(resident.health)}%</span>
              </div>
            </div>
          </div>

          ${resident.skills && resident.skills.length > 0 ? `
            <div class="detail-section skills-info">
              <h3>–ù–∞–≤—ã–∫–∏</h3>
              <div class="skills-grid">
                ${skillsList}
              </div>
            </div>
          ` : ''}

          <div class="detail-section inventory-info">
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <p>${resident.itemsText}</p>
          </div>
        </div>
      `;
    };

    // Resource modal functions
    window.populateResourceModal = function(resourceType, data) {
      const title = document.getElementById('resource-modal-title');
      const content = document.getElementById('resource-modal-content');

      if (!title || !content) return;

      title.textContent = resourceType.toUpperCase();

      let details = '';

      switch(resourceType.toLowerCase()) {
        case 'happiness':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.happiness}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–£—Ä–æ–≤–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞, –Ω–∞–ª–∏—á–∏–µ —Ä–∞–±–æ—Ç—ã, –∑–¥–æ—Ä–æ–≤—å–µ</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–î–æ–≤–æ–ª—å—Å—Ç–≤–æ –∂–∏—Ç–µ–ª–µ–π, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞, –±—É–Ω—Ç—ã</span>
              </div>
              <div class="resource-description">
                <p>–°—á–∞—Å—Ç—å–µ –∂–∏—Ç–µ–ª–µ–π –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å. –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—á–∞—Å—Ç—å—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±—É–Ω—Ç–∞–º –∏ —Å–Ω–∏–∂–µ–Ω–∏—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã.</p>
              </div>
            </div>
          `;
          break;

        case 'defense':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.defense}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</span>
                <span>5 –µ–¥–∏–Ω–∏—Ü –≤ –¥–µ–Ω—å</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–ù–∞–ª–∏—á–∏–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–π, –æ—Ä—É–∂–∏—è, –æ–±—É—á–µ–Ω–Ω—ã—Ö –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –≤–Ω—É—Ç—Ä—å –±—É–Ω–∫–µ—Ä–∞</span>
              </div>
              <div class="resource-description">
                <p>–ó–∞—â–∏—Ç–∞ –±—É–Ω–∫–µ—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å—Ç–µ–Ω, –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∂–∏—Ç–µ–ª–µ–π –∫ –æ–±–æ—Ä–æ–Ω–µ. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ —É—Å–ø–µ—à–Ω—ã—Ö –∞—Ç–∞–∫ –≤—Ä–∞–≥–æ–≤.</p>
              </div>
            </div>
          `;
          break;

        case 'ammo':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ä–æ–Ω–æ–≤</span>
                <span>${data.ammo} —à—Ç.</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ç—Ä–æ–Ω–æ–≤ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–ü–∞—Ç—Ä–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –±—É–Ω–∫–µ—Ä–∞ –æ—Ç –≤—Ä–∞–≥–æ–≤ –∏ –æ—Ö–æ—Ç—ã. –ò—Ö –∑–∞–ø–∞—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤ –æ–ø–∞—Å–Ω–æ–º –º–∏—Ä–µ.</p>
              </div>
            </div>
          `;
          break;

        case 'food':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.food} –µ–¥–∏–Ω–∏—Ü</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–ï–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–µ—Å—É—Ä—Å–æ–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∂–∏–∑–Ω–∏ –∂–∏—Ç–µ–ª–µ–π. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –µ–¥—ã –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –≥–æ–ª–æ–¥—É –∏ —Å–Ω–∏–∂–µ–Ω–∏—é –∑–¥–æ—Ä–æ–≤—å—è.</p>
              </div>
            </div>
          `;
          break;

        case 'water':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.water} –µ–¥–∏–Ω–∏—Ü</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–í–æ–¥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è. –ï—ë –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏—é –∏ —Å–º–µ—Ä—Ç–∏ –∂–∏—Ç–µ–ª–µ–π.</p>
              </div>
            </div>
          `;
          break;

        case 'money':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.money} –º–æ–Ω–µ—Ç</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–î–µ–Ω—å–≥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤, –Ω–∞–π–º–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏—è –±—É–Ω–∫–µ—Ä–∞. –û–Ω–∏ —Ç–∞–∫–∂–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏.</p>
              </div>
            </div>
          `;
          break;

        case 'comfort':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.comfort}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–º–µ—â–µ–Ω–∏–π, –Ω–∞–ª–∏—á–∏–µ —É–¥–æ–±—Å—Ç–≤, –æ—Å–≤–µ—â–µ–Ω–∏–µ</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∂–∏—Ç–µ–ª–µ–π</span>
              </div>
              <div class="resource-description">
                <p>–ö–æ–º—Ñ–æ—Ä—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –º–æ—Ä–∞–ª—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ –∂–∏—Ç–µ–ª–µ–π. –•–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è –∂–∏–∑–Ω–∏ –ø–æ–≤—ã—à–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–Ω–∏–∂–∞—é—Ç —Ä–∏—Å–∫ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π.</p>
              </div>
            </div>
          `;
          break;

        default:
          details = '<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—É—Ä—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
      }

      content.innerHTML = details;
    };

    // Menu functions
    window.continueGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä—É...');
        }
      }
    };

    window.saveGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
        }
      }
    };

    window.loadGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã... (WIP)');
        }
      }
    };

    window.openSettings = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (WIP)');
        }
      }
    };

    window.exitToMenu = function() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é?')) {
        closeModal('menu-modal');
        if (window.game && window.game.scene) {
          const gameScene = window.game.scene.getScene('Game');
          if (gameScene && gameScene.showToast) {
            gameScene.showToast('–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...');
          }
        }
      }
    };

    // Inventory functions
    window.populateInventoryModal = function(inventory, inventoryRows = 1) {
      const grid = document.getElementById('inventory-grid');
      if (!grid) return;

      // Clear existing slots
      grid.innerHTML = '';

      // Create inventory slots (6 columns √ó inventoryRows)
      const totalSlots = 6 * inventoryRows;
      for (let i = 0; i < totalSlots; i++) {
        const slot = document.createElement('div');
        slot.className = 'inventory-slot';
        slot.onclick = () => selectInventorySlot(i);

        const item = inventory ? inventory[i] : null;
        if (item) {
          slot.classList.add('occupied');
          slot.innerHTML = `
            <div class="item">${item.icon || 'üì¶'}</div>
            <div class="quantity">${item.quantity || 1}</div>
          `;
        }

        grid.appendChild(slot);
      }
    };

    window.selectInventorySlot = function(index) {
      console.log('Selected inventory slot:', index);
      // This will be implemented for item interactions
    };

    // Abilities system
    let currentAbilityPoints = 100;
    let currentCategory = 'resources';
    let abilitiesData = {};
    let learnedAbilities = new Set();

    // Initialize abilities data
    function initializeAbilitiesData() {
      abilitiesData = {
        resources: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_cooking',
            name: '–ì–æ—Ç–æ–≤–∫–∞',
            description: '–ü–æ–≤–∞—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –Ω–∞ 1 –µ–¥. –±–æ–ª—å—à–µ –µ–¥—ã',
            cost: 1,
            maxLevel: 2,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üç≥'
          },
          {
            id: 'res_plumbing',
            name: '–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞',
            description: '–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –Ω–∞ 1 –µ–¥. –±–æ–ª—å—à–µ –≤–æ–¥—ã',
            cost: 1,
            maxLevel: 2,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üîß'
          },
          {
            id: 'res_restaurant',
            name: '–†–µ—Å—Ç–æ—Ä–∞–Ω',
            description: '–í —Å—Ç–æ–ª–æ–≤–æ–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üçΩÔ∏è'
          },
          {
            id: 'res_brigade',
            name: '–ë—Ä–∏–≥–∞–¥–∞',
            description: '–í —Ç—É–∞–ª–µ—Ç–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 50 },
            requirements: [],
            icon: 'üöΩ'
          },
          {
            id: 'res_consultation',
            name: '–ö–æ–Ω—Å–∏–ª–∏—É–º',
            description: '–í –≥–æ—Å–ø–∏—Ç–∞–ª–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 650, y: 50 },
            requirements: [],
            icon: 'üè•'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_hunting',
            name: '–î–æ–±—ã—á–∞',
            description: '–û—Ö–æ—Ç–Ω–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 5% –±–æ–ª—å—à–µ –µ–¥—ã',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['res_cooking'],
            icon: 'üèπ'
          },
          {
            id: 'res_scouting',
            name: '–†–∞–∑–≤–µ–¥–∫–∞',
            description: '–†–∞–∑–≤–µ–¥—á–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –±–æ–ª—å—à–µ –¥–æ–±—ã—á–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['res_plumbing'],
            icon: 'üîç'
          },
          {
            id: 'res_science',
            name: '–ù–∞—É–∫–∞',
            description: '–£—á–µ–Ω—ã–µ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –æ–ø—ã—Ç–∞ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 425, y: 150 },
            requirements: ['res_restaurant'],
            icon: 'üî¨'
          },
          {
            id: 'res_chemistry',
            name: '–•–∏–º–∏—è',
            description: '–•–∏–º–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –æ–ø—ã—Ç–∞ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 575, y: 150 },
            requirements: ['res_brigade'],
            icon: 'üß™'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_market_economy',
            name: '–†—ã–Ω–æ—á–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞',
            description: '–ü—Ä–æ–¥–∞–≤—Ü—ã –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –¥–µ–Ω–µ–≥ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 250 },
            requirements: ['res_hunting', 'res_scouting'],
            icon: 'üí∞'
          },
          {
            id: 'res_penicillin',
            name: '–ü–µ–Ω–∏—Ü–∏–ª–ª–∏–Ω',
            description: '–î–æ–∫—Ç–æ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –Ω–∞ 1 –µ–¥. –∑–¥–æ—Ä–æ–≤—å—è –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 250 },
            requirements: ['res_science', 'res_chemistry'],
            icon: 'üíä'
          }
        ],
        bunker: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_demolition',
            name: '–î–µ–º–æ–Ω—Ç–∞–∂',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—é –∫–æ–º–Ω–∞—Ç',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üí•'
          },
          {
            id: 'bunk_storage',
            name: '–•—Ä–∞–Ω–∏–ª–∏—â–µ',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–°–∫–ª–∞–¥"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üì¶'
          },
          {
            id: 'bunk_elevator',
            name: '–õ–∏—Ñ—Ç',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–õ–∏—Ñ—Ç"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üõó'
          },
          {
            id: 'bunk_armory',
            name: '–û—Ä—É–∂–µ–π–Ω–∞—è',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–û—Ä—É–∂–µ–π–Ω–∞—è"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 50 },
            requirements: [],
            icon: 'üî´'
          },
          {
            id: 'bunk_server',
            name: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–°–µ—Ä–≤–µ—Ä–Ω–∞—è"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 650, y: 50 },
            requirements: [],
            icon: 'üíª'
          },
          {
            id: 'bunk_market',
            name: '–†—ã–Ω–æ–∫',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–†—ã–Ω–æ–∫"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 800, y: 50 },
            requirements: [],
            icon: 'üè™'
          },
          {
            id: 'bunk_classroom',
            name: '–û–±—É—á–µ–Ω–∏–µ',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 950, y: 50 },
            requirements: [],
            icon: 'üìö'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_fast_building',
            name: '–ë—ã—Å—Ç—Ä–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ',
            description: '–£—Å–∫–æ—Ä—è–µ—Ç –ø–æ—Å—Ç—Ä–æ–π–∫—É –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['bunk_demolition'],
            icon: 'üèóÔ∏è'
          },
          {
            id: 'bunk_energy_storage',
            name: '–≠–Ω–µ—Ä–≥–æ—Ö—Ä–∞–Ω–∏–ª–∏—â–µ',
            description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á–∏—Å–ª–æ –∫–æ–º–Ω–∞—Ç, –ø–∏—Ç–∞–µ–º—ã—Ö —Å—Ç–∞–Ω—Ü–∏–µ–π –Ω–∞ 1',
            cost: 2,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['bunk_storage'],
            icon: '‚ö°'
          },
          {
            id: 'bunk_building_discount',
            name: '–°–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ',
            description: '–°–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 425, y: 150 },
            requirements: ['bunk_elevator'],
            icon: 'üí∞'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_territory_expansion',
            name: '–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏',
            description: '–£–±–∏—Ä–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ –∏ —à–∏—Ä–∏–Ω–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 250 },
            requirements: ['bunk_fast_building', 'bunk_energy_storage'],
            icon: 'üåç'
          }
        ],
        defense: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_banishment',
            name: '–ò–∑–≥–Ω–∞–Ω–∏–µ',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–≥–Ω–∞–Ω–∏—è –∂–∏—Ç–µ–ª–µ–π',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üö™'
          },
          {
            id: 'def_armor',
            name: '–ë—Ä–æ–Ω—è',
            description: '–ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ —Å—Ç–µ–Ω +5 –µ–¥.',
            cost: 1,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üõ°Ô∏è'
          },
          {
            id: 'def_repair',
            name: '–ü–æ—á–∏–Ω–∫–∞',
            description: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è —Å—Ç–µ–Ω +1–µ–¥./—á–∞—Å',
            cost: 1,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üîß'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_damage_boost',
            name: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞',
            description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –æ—Ç –æ—Ä—É–∂–∏—è –Ω–∞ 1 –µ–¥.',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['def_armor'],
            icon: '‚öîÔ∏è'
          },
          {
            id: 'def_shotgun',
            name: '–î—Ä–æ–±–æ–≤–∏–∫',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä–æ–±–æ–≤–∏–∫',
            cost: 2,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['def_repair'],
            icon: 'üî´'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_assault_rifle',
            name: '–®—Ç—É—Ä–º',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —à—Ç—É—Ä–º–æ–≤—É—é –≤–∏–Ω—Ç–æ–≤–∫—É',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 250 },
            requirements: ['def_damage_boost', 'def_shotgun'],
            icon: 'üî´'
          },
          
          // –≠–ª–∏—Ç–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (4 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_sniper_rifle',
            name: '–°–Ω–∞–π–ø–µ—Ä',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–Ω–∞–π–ø–µ—Ä—Å–∫—É—é –≤–∏–Ω—Ç–æ–≤–∫—É',
            cost: 4,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 125, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: 'üéØ'
          },
          {
            id: 'def_execution',
            name: '–ö–∞–∑–Ω—å',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–±–∏–π—Å—Ç–≤–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π',
            cost: 4,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: '‚ö∞Ô∏è'
          },
          {
            id: 'def_army',
            name: '–ê—Ä–º–∏—è',
            description: '5% –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ä–æ–Ω—ã –¥–ª—è –°–æ–ª–¥–∞—Ç',
            cost: 4,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 425, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: 'üë•'
          },
          
          // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (5 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_masochist',
            name: '–ú–∞–∑–æ—Ö–∏—Å—Ç',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–ø—É—Å—Ç–∏—Ç—å –≤—Ä–∞–≥–∞ –≤ –±—É–Ω–∫–µ—Ä',
            cost: 5,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 450 },
            requirements: ['def_sniper_rifle', 'def_execution'],
            icon: 'üòà'
          },
          {
            id: 'def_misfire',
            name: '–û—Å–µ—á–∫–∞',
            description: '–®–∞–Ω—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ä–æ–Ω –ø—Ä–∏ —Å—Ç—Ä–µ–ª—å–±–µ +5%',
            cost: 5,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 350, y: 450 },
            requirements: ['def_army'],
            icon: 'üí•'
          }
        ],
        misc: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'misc_skill_points',
            name: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—á–∫–æ–≤',
            description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∞ 1 –µ–¥.',
            cost: 1,
            maxLevel: 3,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: '‚≠ê'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'misc_night_speed',
            name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏',
            description: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['misc_skill_points'],
            icon: 'üåô'
          },
          {
            id: 'misc_day_speed',
            name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è',
            description: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è –Ω–∞ 5%',
            cost: 2,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['misc_skill_points'],
            icon: '‚òÄÔ∏è'
          }
        ]
      };
    }

    // Abilities functions
    window.populateAbilitiesModal = function(abilities) {
      // Initialize abilities data only once
      if (Object.keys(abilitiesData).length === 0) {
        initializeAbilitiesData();
      }
      
      setupCategoryTabs();
      renderAbilityTree();
      updateAbilityPoints();
    };

    window.populateRoomSelectionModal = function(gameScene = null) {
      console.log('[HTML] populateRoomSelectionModal called with gameScene:', !!gameScene);
      
      const roomSelectionGrid = document.querySelector('.room-selection-grid');
      if (!roomSelectionGrid) return;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ GameScene –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
      window.currentGameScene = gameScene;
      console.log('[HTML] currentGameScene set to:', !!window.currentGameScene);
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
      const abilitiesData = window.getAbilitiesData ? window.getAbilitiesData() : null;
      console.log('[HTML] Abilities data:', abilitiesData);

      // Clear existing content
      roomSelectionGrid.innerHTML = '';

      // Define available room types with their properties and ability requirements
      const availableRooms = [
        {
          id: '–°–ø–∞–ª—å–Ω—è',
          name: '–°–ø–∞–ª—å–Ω—è',
          description: '–ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Å–Ω–∞ –∂–∏—Ç–µ–ª–µ–π. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∏ –∑–¥–æ—Ä–æ–≤—å–µ.',
          icon: 'üõèÔ∏è',
          cost: '100 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–°—Ç–æ–ª–æ–≤–∞—è',
          name: '–°—Ç–æ–ª–æ–≤–∞—è',
          description: '–ú–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üçΩÔ∏è',
          cost: '150 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–¢—É–∞–ª–µ—Ç',
          name: '–¢—É–∞–ª–µ—Ç',
          description: '–°–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üöΩ',
          cost: '80 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–ì–æ—Å–ø–∏—Ç–∞–ª—å',
          name: '–ì–æ—Å–ø–∏—Ç–∞–ª—å',
          description: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ. –õ–µ—á–∏—Ç –±–æ–ª—å–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üè•',
          cost: '200 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–°–∫–ª–∞–¥',
          name: '–°–∫–ª–∞–¥',
          description: '–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.',
          icon: 'üì¶',
          cost: '90 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_storage', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–•—Ä–∞–Ω–∏–ª–∏—â–µ"
          category: 'advanced'
        },
        {
          id: '–õ–∏—Ñ—Ç',
          name: '–õ–∏—Ñ—Ç',
          description: '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —ç—Ç–∞–∂–∞–º–∏.',
          icon: 'üõó',
          cost: '180 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_elevator', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–õ–∏—Ñ—Ç"
          category: 'advanced'
        },
        {
          id: '–û—Ä—É–∂–µ–π–Ω–∞—è',
          name: '–û—Ä—É–∂–µ–π–Ω–∞—è',
          description: '–•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ä—É–∂–∏—è –∏ –±–æ–µ–ø—Ä–∏–ø–∞—Å–æ–≤.',
          icon: 'üî´',
          cost: '250 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_armory', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–û—Ä—É–∂–µ–π–Ω–∞—è"
          category: 'advanced'
        },
                  {
            id: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            name: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            description: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏.',
            icon: 'üíª',
            cost: '300 –º–æ–Ω–µ—Ç',
            requiredAbility: 'bunk_server', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–°–µ—Ä–≤–µ—Ä–Ω–∞—è"
            category: 'advanced'
          },
        {
          id: '–†—ã–Ω–æ–∫',
          name: '–†—ã–Ω–æ–∫',
          description: '–¢–æ—Ä–≥–æ–≤–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–±–º–µ–Ω–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏.',
          icon: 'üè™',
          cost: '220 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_market', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–†—ã–Ω–æ–∫"
          category: 'advanced'
        },
                  {
            id: '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
            name: '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
            description: '–ú–µ—Å—Ç–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤.',
            icon: 'üìö',
            cost: '160 –º–æ–Ω–µ—Ç',
            requiredAbility: 'bunk_classroom', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞"
            category: 'advanced'
          },
        {
          id: '–°—Ç–∞–Ω—Ü–∏—è',
          name: '–°—Ç–∞–Ω—Ü–∏—è',
          description: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏–µ–π –¥–æ 3 –∫–æ–º–Ω–∞—Ç.',
          icon: '‚ö°',
          cost: '400 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –î–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞)
          category: 'critical'
        },
        {
          id: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è',
          name: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è',
          description: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ —Å–∏—Å—Ç–µ–º.',
          icon: 'üîß',
          cost: '180 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –î–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        }
      ];

      // Filter rooms based on learned abilities
      console.log('=== ROOM FILTERING DEBUG ===');
      console.log('Total rooms available:', availableRooms.length);
      console.log('Abilities data:', JSON.stringify(abilitiesData, null, 2));

      const filteredRooms = availableRooms.filter(room => {
        console.log(`--- Checking room: ${room.name} ---`);
        console.log(`Required ability: ${room.requiredAbility}`);

        // –ï—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏, –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
        if (!room.requiredAbility) {
          console.log(`‚úÖ Room ${room.name} is basic, showing`);
          return true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑—É—á–µ–Ω–∞ –ª–∏ —Ç—Ä–µ–±—É–µ–º–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
        if (abilitiesData && abilitiesData.learnedAbilities) {
          console.log(`Learned abilities:`, abilitiesData.learnedAbilities);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö (–º–∞—Å—Å–∏–≤ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –æ–±—ä–µ–∫—Ç—ã)
          let isLearned = false;

          if (Array.isArray(abilitiesData.learnedAbilities)) {
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏
            if (typeof abilitiesData.learnedAbilities[0] === 'string') {
              isLearned = abilitiesData.learnedAbilities.includes(room.requiredAbility);
            }
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã
            else if (typeof abilitiesData.learnedAbilities[0] === 'object') {
              const learnedAbility = abilitiesData.learnedAbilities.find(ability =>
                ability.id === room.requiredAbility
              );
              isLearned = learnedAbility && learnedAbility.currentLevel > 0;
            }
          }

          console.log(`Looking for ability: ${room.requiredAbility}`);
          console.log(`Is learned: ${isLearned}`);

          if (isLearned) {
            console.log(`‚úÖ Room ${room.name} - ability found and learned`);
          } else {
            console.log(`‚ùå Room ${room.name} - ability not learned or not found`);
          }

          return isLearned;
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã
        console.log(`‚ö†Ô∏è No abilities data, showing room ${room.name}`);
        return true;
      });

      console.log('=== FILTERING COMPLETE ===');
      console.log(`Filtered rooms: ${filteredRooms.length}/${availableRooms.length}`);
      filteredRooms.forEach(room => console.log(`- ${room.name}`));
      
      console.log('[HTML] Available rooms:', availableRooms.length, 'Filtered rooms:', filteredRooms.length);
      
      // Helper function to get ability name by ID
      function getAbilityName(abilityId) {
        const abilityNames = {
          'bunk_storage': '–•—Ä–∞–Ω–∏–ª–∏—â–µ',
          'bunk_elevator': '–õ–∏—Ñ—Ç',
          'bunk_armory': '–û—Ä—É–∂–µ–π–Ω–∞—è',
          'bunk_server': '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
          'bunk_market': '–†—ã–Ω–æ–∫',
          'bunk_classroom': '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞'
        };
        return abilityNames[abilityId] || abilityId;
      }
      
      // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
      /*
      console.log('=== TEMPORARY DEBUG: Showing all rooms ===');
      availableRooms.forEach(room => console.log(`Room: ${room.name}, Required: ${room.requiredAbility}`));
      */

      // Use filtered rooms for now, but we can switch to availableRooms for testing
      const roomsToShow = filteredRooms; // Change to availableRooms to show all

      // Create room option elements
      roomsToShow.forEach(room => {
        const roomOption = document.createElement('div');
        roomOption.className = 'room-option';
        roomOption.dataset.roomId = room.id;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–æ–º–Ω–∞—Ç
        if (room.category === 'critical') {
          roomOption.classList.add('critical-room');
        } else if (room.category === 'advanced') {
          roomOption.classList.add('advanced-room');
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
        let isLocked = false;

        if (room.requiredAbility) {
          if (abilitiesData && abilitiesData.learnedAbilities) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö
            if (Array.isArray(abilitiesData.learnedAbilities)) {
              if (typeof abilitiesData.learnedAbilities[0] === 'string') {
                // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏
                isLocked = !abilitiesData.learnedAbilities.includes(room.requiredAbility);
              } else if (typeof abilitiesData.learnedAbilities[0] === 'object') {
                // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã
                isLocked = !abilitiesData.learnedAbilities.find(ability =>
                  ability.id === room.requiredAbility && ability.currentLevel > 0
                );
              }
            } else {
              isLocked = true; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
            }
          } else {
            isLocked = true; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
          }
        }

        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –ª–æ–≥ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
        // console.log(`[HTML] Room ${room.name}, required: ${room.requiredAbility}, isLocked: ${isLocked}`);

        if (isLocked) {
          roomOption.classList.add('locked-room');
        } else {
          roomOption.classList.add('unlocked-room');
        }
        
        roomOption.innerHTML = `
          <div class="room-icon">${room.icon}</div>
          <div class="room-name">${room.name}</div>
          <div class="room-description">${room.description}</div>
          <div class="room-cost">${room.cost}</div>
          ${room.requiredAbility ? `<div class="room-requirement">–¢—Ä–µ–±—É–µ—Ç: ${getAbilityName(room.requiredAbility)}</div>` : ''}
        `;

        // Add click handler
        roomOption.addEventListener('click', () => {
          console.log('[HTML] Room clicked:', room.id, room.name);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
          if (roomOption.classList.contains('locked-room')) {
            console.log('[HTML] Room is locked, cannot select');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            alert(`–ö–æ–º–Ω–∞—Ç–∞ "${room.name}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${getAbilityName(room.requiredAbility)}`);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
          if (!roomOption.classList.contains('unlocked-room') && room.requiredAbility) {
            console.log('[HTML] Room is not unlocked, cannot select');
            alert(`–ö–æ–º–Ω–∞—Ç–∞ "${room.name}" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${getAbilityName(room.requiredAbility)}`);
            return;
          }
          
          // Remove previous selection
          document.querySelectorAll('.room-option').forEach(opt => opt.classList.remove('selected'));
          
          // Select this room
          roomOption.classList.add('selected');
          
          // Call game scene to handle room placement
          const gameScene = window.currentGameScene;
          console.log('[HTML] Attempting to use gameScene:', !!gameScene);
          console.log('[HTML] window.currentGameScene exists:', !!window.currentGameScene);
          
          if (gameScene) {
            console.log('[HTML] GameScene found:', !!gameScene);
            console.log('[HTML] simpleBunker exists:', !!gameScene.simpleBunker);
            
            // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã –≤ bunkerView
            if (gameScene.simpleBunker && typeof gameScene.simpleBunker.setSelectedRoomType === 'function') {
              console.log('[HTML] Calling setSelectedRoomType with:', room.id);
              gameScene.simpleBunker.setSelectedRoomType(room.id);
            } else {
              console.warn('[HTML] simpleBunker or setSelectedRoomType not available');
            }
            
            // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            if (typeof gameScene.selectRoomTypeForPlacement === 'function') {
              console.log('[HTML] Calling selectRoomTypeForPlacement with:', room.id);
              gameScene.selectRoomTypeForPlacement(room.id);
            } else {
              console.warn('[HTML] selectRoomTypeForPlacement not available');
            }
          } else {
            console.error('[HTML] GameScene not available in currentGameScene');
            console.log('[HTML] Available window properties:', Object.keys(window).filter(k => k.includes('game')));
          }
          
          // Close the modal
          closeModal('room-selection-modal');
        });

        roomSelectionGrid.appendChild(roomOption);
      });
    };

    function setupCategoryTabs() {
      const tabs = document.querySelectorAll('.category-tab');
      
      // Remove existing event listeners to prevent duplicates
      tabs.forEach(tab => {
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);
      });
      
      // Add new event listeners
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentCategory = tab.dataset.category;
          
          // Clear any visible tooltips before rendering
          const tooltips = document.querySelectorAll('.ability-tooltip');
          tooltips.forEach(tooltip => {
            tooltip.remove();
          });
          
          renderAbilityTree();
        });
      });
    }

    function renderAbilityTree() {
      const tree = document.getElementById('ability-tree');
      if (!tree) return;

      // Clear existing content
      tree.innerHTML = '<svg class="connection-lines" id="connection-lines"></svg>';

      // Clear any visible tooltips
      const tooltips = document.querySelectorAll('.ability-tooltip');
      tooltips.forEach(tooltip => {
        tooltip.remove();
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
      if (typeof window.updateRoomSelectionModal === 'function') {
        console.log('[HTML] Updating room selection modal after ability tree render');
        setTimeout(() => window.updateRoomSelectionModal(), 100);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç –≤ Phaser
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.simpleBunker && typeof gameScene.simpleBunker.updateRemoveButtonVisibility === 'function') {
          console.log('[HTML] Updating remove button visibility after ability change');
          setTimeout(() => gameScene.simpleBunker.updateRemoveButtonVisibility(), 200);
        }
      }
      
      const connections = document.getElementById('connection-lines');
      if (!connections) return;

      const categoryAbilities = abilitiesData[currentCategory] || [];
      
      // Render ability nodes
      categoryAbilities.forEach(ability => {
        const node = createAbilityNode(ability);
        tree.appendChild(node);
      });

      // Render connection lines
      renderConnections(categoryAbilities);
    }

    function createAbilityNode(ability) {
      const node = document.createElement('div');
      node.className = 'ability-node';
      node.dataset.abilityId = ability.id;
      
      // Determine node state
      if (ability.currentLevel >= ability.maxLevel) {
        node.classList.add('maxed');
      } else if (ability.currentLevel > 0) {
        node.classList.add('learned');
      } else if (canLearnAbility(ability)) {
        node.classList.add('unlocked');
      } else {
        node.classList.add('locked');
      }

      // Set position
      node.style.left = ability.position.x + 'px';
      node.style.top = ability.position.y + 'px';

      // Set content
      const bonusText = getBonusText(ability);
      node.innerHTML = `
        <div class="name">${ability.name}</div>
        <div class="description">${ability.description}</div>
        ${bonusText ? `<div class="bonus ${ability.currentLevel > 0 ? 'current' : ''}">${bonusText}</div>` : ''}
        ${ability.currentLevel > 0 ? `<div class="level">${ability.currentLevel}</div>` : ''}
      `;

      // Add event listeners
      node.addEventListener('click', () => handleAbilityClick(ability));
      node.addEventListener('mouseenter', (e) => showAbilityTooltip(e, ability));
      node.addEventListener('mouseleave', hideAbilityTooltip);

      return node;
    }

    function renderConnections(abilities) {
      const connections = document.getElementById('connection-lines');
      
      abilities.forEach(ability => {
        ability.requirements.forEach(reqId => {
          const reqAbility = abilities.find(a => a.id === reqId);
          if (reqAbility) {
            const line = createConnectionLine(ability, reqAbility);
            connections.appendChild(line);
          }
        });
      });
    }

    function createConnectionLine(from, to) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      const fromX = from.position.x + 60; // Center of the node (120px width / 2)
      const fromY = from.position.y + 40; // Center of the node (80px height / 2)
      const toX = to.position.x + 60;
      const toY = to.position.y + 40;

      line.setAttribute('x1', fromX);
      line.setAttribute('y1', fromY);
      line.setAttribute('x2', toX);
      line.setAttribute('y2', toY);
      line.setAttribute('class', 'connection-line');

      // Determine line state
      if (from.currentLevel > 0 && to.currentLevel > 0) {
        line.classList.add('learned');
      } else if (canLearnAbility(from) && canLearnAbility(to)) {
        line.classList.add('unlocked');
      }

      return line;
    }

    function canLearnAbility(ability) {
      // Check if all requirements are met
      const requirementsMet = ability.requirements.every(reqId => {
        const reqAbility = findAbilityById(reqId);
        return reqAbility && reqAbility.currentLevel > 0;
      });

      // Check if we have enough points
      const canAfford = currentAbilityPoints >= ability.cost;

      // Check if not maxed out
      const notMaxed = ability.currentLevel < ability.maxLevel;

      return requirementsMet && canAfford && notMaxed;
    }

    function findAbilityById(id) {
      for (const category of Object.values(abilitiesData)) {
        const ability = category.find(a => a.id === id);
        if (ability) return ability;
      }
      return null;
    }

    function getBonusText(ability) {
      if (ability.currentLevel === 0) return null;
      
      const totalBonus = ability.currentLevel * getAbilityBonusPerLevel(ability);
      const maxBonus = ability.maxLevel * getAbilityBonusPerLevel(ability);
      
      if (ability.maxLevel === 1) {
        return `+${totalBonus}`;
      } else {
        return `+${totalBonus}/${maxBonus}`;
      }
    }

    function getAbilityBonusPerLevel(ability) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–Ω—É—Å –∑–∞ –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
      switch (ability.id) {
        case 'res_cooking':
          return 1; // +1 –µ–¥–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_plumbing':
          return 1; // +1 –≤–æ–¥–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_hunting':
          return 5; // +5% –µ–¥—ã –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_scouting':
          return 5; // +5% –¥–æ–±—ã—á–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_science':
          return 1; // +1 –æ–ø—ã—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_chemistry':
          return 1; // +1 –æ–ø—ã—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_market_economy':
          return 1; // +1 –¥–µ–Ω—å–≥–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_penicillin':
          return 1; // +1 –∑–¥–æ—Ä–æ–≤—å–µ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –ë—É–Ω–∫–µ—Ä —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'bunk_fast_building':
          return 5; // +5% —Å–∫–æ—Ä–æ—Å—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'bunk_building_discount':
          return 5; // +5% —Å–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'bunk_energy_storage':
          return 1; // +1 –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –ó–∞—â–∏—Ç–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'def_armor':
          return 5; // +5 –µ–¥. –∑–¥–æ—Ä–æ–≤—å—è —Å—Ç–µ–Ω –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_repair':
          return 1; // +1 –µ–¥./—á–∞—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_damage_boost':
          return 1; // +1 –µ–¥. —É—Ä–æ–Ω–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_army':
          return 5; // +5% —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞—Ç—Ä–æ–Ω–æ–≤ –¥–ª—è —Å–æ–ª–¥–∞—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_misfire':
          return 5; // +5% —à–∞–Ω—Å –æ—Å–µ—á–∫–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –†–∞–∑–Ω–æ–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'misc_skill_points':
          return 1; // +1 –æ—á–∫–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'misc_night_speed':
          return 5; // +5% —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'misc_day_speed':
          return 5; // +5% —É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        default:
          return 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é +1
      }
    }

    function handleAbilityClick(ability) {
      if (!canLearnAbility(ability)) {
        if (ability.currentLevel >= ability.maxLevel) {
          showToast('–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–∑—É—á–µ–Ω–∞!');
        } else if (ability.currentLevel > 0) {
          showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!');
        } else {
          showToast('–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!');
        }
        return;
      }

      // Learn/upgrade ability
      currentAbilityPoints -= ability.cost;
      ability.currentLevel++;
      learnedAbilities.add(ability.id);

      // Update UI
      updateAbilityPoints();
      renderAbilityTree();

      showToast(`–ò–∑—É—á–µ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${ability.name} (—É—Ä–æ–≤–µ–Ω—å ${ability.currentLevel})`);
    }

    function showAbilityTooltip(event, ability) {
      const tooltip = document.createElement('div');
      tooltip.className = 'ability-tooltip';
      
      const bonusText = getBonusText(ability);
      const bonusInfo = bonusText ? `<div class="cost">–¢–µ–∫—É—â–∏–π –±–æ–Ω—É—Å: ${bonusText}</div>` : '';
      
      tooltip.innerHTML = `
        <h4>${ability.name}</h4>
        <div class="description">${ability.description}</div>
        <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${ability.cost} –æ—á–∫–æ–≤</div>
        <div class="cost">–£—Ä–æ–≤–µ–Ω—å: ${ability.currentLevel}/${ability.maxLevel}</div>
        ${bonusInfo}
        ${ability.requirements.length > 0 ? 
          `<div class="requirements">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: ${ability.requirements.map(id => findAbilityById(id)?.name).join(', ')}</div>` : 
          '<div class="requirements">–ë–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</div>'
        }
      `;

      // Position tooltip relative to cursor
      const rect = event.target.getBoundingClientRect();
      const tooltipWidth = 250;
      const tooltipHeight = 150;
      
      // Calculate position to ensure tooltip is visible
      let left = rect.right + 10;
      let top = rect.top - 10;
      
      // Check if tooltip would go off the right edge
      if (left + tooltipWidth > window.innerWidth) {
        left = rect.left - tooltipWidth - 10;
      }
      
      // Check if tooltip would go off the bottom edge
      if (top + tooltipHeight > window.innerHeight) {
        top = window.innerHeight - tooltipHeight - 10;
      }
      
      // Ensure tooltip doesn't go off the left or top edges
      left = Math.max(10, left);
      top = Math.max(10, top);
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';

      document.body.appendChild(tooltip);
      
      // Show tooltip
      setTimeout(() => tooltip.classList.add('show'), 100);
      
      // Store reference for removal
      event.target.tooltip = tooltip;
    }

    function hideAbilityTooltip(event) {
      if (event.target.tooltip) {
        event.target.tooltip.remove();
        event.target.tooltip = null;
      }
    }

    function updateAbilityPoints() {
      const pointsElement = document.getElementById('ability-points');
      if (pointsElement) {
        pointsElement.textContent = currentAbilityPoints;
      }
    }

    function clearAbilityTree() {
      const tree = document.getElementById('ability-tree');
      if (tree) {
        tree.innerHTML = '<svg class="connection-lines" id="connection-lines"></svg>';
      }
      
      // Clear all visible tooltips
      clearAllTooltips();
    }

    function clearAllTooltips() {
      const tooltips = document.querySelectorAll('.ability-tooltip');
      tooltips.forEach(tooltip => {
        tooltip.remove();
      });
    }

    function showToast(message) {
      // Simple toast implementation
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--bunker-gold);
        color: var(--bunker-bg);
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 10000;
        font-size: 12px;
        max-width: 300px;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Phaser)
    window.getAbilitiesData = function() {
      return {
        currentPoints: currentAbilityPoints,
        learnedAbilities: Array.from(learnedAbilities),
        abilitiesData: abilitiesData
      };
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Phaser)
    window.setAbilitiesData = function(data) {
      if (data.currentPoints !== undefined) {
        currentAbilityPoints = data.currentPoints;
      }
      if (data.learnedAbilities) {
        learnedAbilities = new Set(data.learnedAbilities);
      }
      if (data.abilitiesData) {
        abilitiesData = data.abilitiesData;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      updateAbilityPoints();
      renderAbilityTree();
    };

    // Universal resource click handler
    window.handleResourceClick = function(resourceType) {
      console.log('Resource clicked:', resourceType);

      // Add visual feedback
      const clickedElement = event?.target;
      if (clickedElement) {
        clickedElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
          clickedElement.style.transform = '';
        }, 100);
      }

      if (resourceType === 'residents') {
        window.openResidents();
      } else if (resourceType === 'enemies') {
        window.openEnemies();
      } else {
        window.openResource(resourceType);
      }
    };

    // Debug functions for testing
    window.debugOpenPopulation = function() {
      console.log('Debug: Opening population modal');
      window.openResidents();
    };

    window.debugOpenHappiness = function() {
      console.log('Debug: Opening happiness modal');
      window.openResource('happiness');
    };

    window.debugOpenInventory = function() {
      console.log('Debug: Opening inventory modal');
      window.openInventory();
    };
  </script>

</html>


