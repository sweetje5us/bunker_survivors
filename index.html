<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Bunker Survivors</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
      /* –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã –¥–ª—è —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è */
      @font-face {
        font-family: 'pobeda-regular';
        src: url('src/fonts/pobeda-regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: '28 Days Later Cyr Regular';
        src: url('src/fonts/28 Days Later Cyr Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: 'Belukha';
        src: url('src/fonts/Belukha.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: 'JIKHAR_2';
        src: url('src/fonts/JIKHAR_2.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: 'MovieLettersCyrillic';
        src: url('src/fonts/MovieLettersCyrillic.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: 'Skratch Punk Regular';
        src: url('src/fonts/Skratch Punk Regular.ttf') format('truetype');
        font-weight: normal;
        font-style: normal;
      }
      
      @font-face {
        font-family: 'Vogue Bold';
        src: url('src/fonts/Vogue Bold.ttf') format('truetype');
        font-weight: bold;
        font-style: normal;
      }
      
      html, body { height: 100%; margin: 0; background:#111; overflow: hidden; }
      #game {
        width: 100vw;
        height: var(--app-vh, 100dvh);
        display:flex;
      }
      canvas { display:block; margin:auto; image-rendering: pixelated; image-rendering: crisp-edges; }
      
      /* –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
      .modal {
        pointer-events: auto;
        touch-action: pan-y; /* –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
      }
      
      /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –∂–µ—Å—Ç—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
      .room-selection-grid {
        touch-action: pan-y;
        -webkit-overflow-scrolling: touch;
      }
    </style>
  </head>
  <body>
    <div id="game"></div>

    <!-- Game UI Overlay Container -->
    <div id="game-ui-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: auto; z-index: 10000; pointer-events: none;"></div>

    <script type="module" src="/src/main.ts"></script>
    <script type="module" src="/src/ui/ui-manager.js"></script>
  </body>
  <script>
    // Mobile viewport height fix (fallback for browsers without 100dvh)
    function setAppVh() {
      document.documentElement.style.setProperty('--app-vh', window.innerHeight + 'px')
    }
    setAppVh()
    window.addEventListener('resize', setAppVh)
    window.addEventListener('orientationchange', setAppVh)

    // Prevent passive pinch-zoom scroll issues on mobile
    document.addEventListener('gesturestart', function (e) { e.preventDefault() }, { passive: false })

    // Ensure Phaser interactions are enabled by default when page loads
    window.addEventListener('load', function() {
      console.log('[ModalManager] Page loaded, ensuring Phaser interactions are enabled');
      setTimeout(() => {
        window.enablePhaserInteractions();
      }, 500); // Give time for Phaser to initialize
    });
  </script>

  <!-- Global UI functions for HTML overlay -->
  <script>
    // Global functions for UI overlay button clicks
    window.openInventory = function() {
      console.log('[openInventory] Opening inventory modal');
      
      // Open modal first
      openModal('inventory-modal');

      // Initialize weapon system when inventory is opened
      setTimeout(() => {
        console.log('[openInventory] Initializing weapon system...');
        
        if (window.initializeWeaponSystem) {
          window.initializeWeaponSystem();
        } else {
          console.warn('[openInventory] initializeWeaponSystem function not found');
        }

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –æ—Ä—É–∂–∏–µ
        if (window.forceWeaponSync) {
          setTimeout(() => {
            window.forceWeaponSync();
            console.log('[openInventory] Weapon sync completed');
          }, 50);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è GameScene
        if (window.game && window.game.scene && typeof populateInventoryModal === 'function') {
          const gameScene = window.game.scene.getScene('Game');
          if (gameScene && gameScene.inventoryRows) {
            console.log(`[openInventory] Refreshing inventory with ${gameScene.inventoryRows} rows from GameScene`);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
            if (window.updateAllResourceDisplays) {
              window.updateAllResourceDisplays();
            }

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏–∑ GameScene –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            let inventoryData = [];
            if (gameScene.getDefaultInventory) {
              inventoryData = gameScene.getDefaultInventory();
            }

            populateInventoryModal(inventoryData, gameScene.inventoryRows);
          }
        }
        
        console.log('[openInventory] Inventory modal setup completed');
      }, 100);
    };

    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞ window
    openInventory = window.openInventory;
    openJournal = window.openJournal;
    openAbilities = window.openAbilities;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∂—É—Ä–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    window.openJournal = function() {
      console.log('[openJournal] Opening journal modal');
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º –∂—É—Ä–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
      if (window.populateJournalModal) {
        window.populateJournalModal();
      }
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      openModal('journal-modal');
    };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    window.populateJournalModal = function() {
      const journalContent = document.getElementById('journal-content');
      if (!journalContent) {
        return;
      }

      // –ñ–¥–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–æ
      setTimeout(() => {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–µ—Ç–∫–∞–º
        window.initializeTagFilters();

        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ—Å—Ç–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π
        continuePopulateJournal();
      }, 100);

      function continuePopulateJournal() {

        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notifications = window.gameNotifications.getAll();

        if (notifications.length === 0) {
          journalContent.innerHTML = '<div class="no-notifications">–ü–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
          return;
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
        const filteredNotifications = window.gameNotifications.applyFilters(notifications);

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –¥–Ω—è–º
        const notificationsByDay = {};
        filteredNotifications.forEach(notification => {
          if (!notificationsByDay[notification.day]) {
            notificationsByDay[notification.day] = [];
          }
          notificationsByDay[notification.day].push(notification);
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        const sortedDays = Object.keys(notificationsByDay).sort((a, b) => parseInt(b) - parseInt(a));

        let journalHTML = '';

        sortedDays.forEach(day => {
          const dayNotifications = notificationsByDay[day];

          journalHTML += `
            <div class="journal-day">
              <h3 class="day-header">–î–µ–Ω—å ${day}</h3>
              <div class="day-notifications">
          `;

          dayNotifications.forEach(notification => {
            const typeClass = notification.type || 'info';
            const readClass = notification.read ? 'read' : 'unread';

            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –º–µ—Ç–æ–∫
            const tagsHTML = notification.tags && notification.tags.length > 0 ?
              `<div class="notification-tags">
                ${notification.tags.map(tag => `<span class="notification-tag ${tag}">${window.getTagLabel(tag)}</span>`).join('')}
              </div>` : '';

            journalHTML += `
              <div class="notification-item ${typeClass} ${readClass}" data-id="${notification.id}">
                <div class="notification-content">
                  <div class="notification-message">${notification.message}</div>
                  <div class="notification-meta">
                    <span class="notification-time">${notification.timestamp}</span>
                    <span class="notification-type">${window.getTypeLabel(notification.type)}</span>
                  </div>
                  ${tagsHTML}
                </div>
                <div class="notification-actions">
                  <button class="mark-read-btn" onclick="window.markNotificationAsRead('${notification.id}')"
                          ${notification.read ? 'disabled' : ''}>
                    ${notification.read ? '‚úì' : '–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º'}
                  </button>
                </div>
              </div>
            `;
          });

          journalHTML += `
              </div>
            </div>
          `;
        });

        journalContent.innerHTML = journalHTML;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const totalElement = document.getElementById('total-notifications');
        const unreadElement = document.getElementById('unread-notifications');

        if (totalElement) {
          totalElement.textContent = filteredNotifications.length;
        }
        if (unreadElement) {
          unreadElement.textContent = window.gameNotifications.getUnreadCount();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
        window.gameNotifications.updateNotificationCounter();


      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∫–∏ —Ç–∏–ø–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    window.getTypeLabel = function(type) {
      const labels = {
        'info': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è',
        'success': '–£—Å–ø–µ—Ö',
        'warning': '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
        'error': '–û—à–∏–±–∫–∞'
      };
      return labels[type] || '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è';
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Ç–∫–∏ –º–µ—Ç–∫–∏
    window.getTagLabel = function(tag) {
      const labels = {
        'resident': '–ñ–∏—Ç–µ–ª–∏',
        'enemy': '–í—Ä–∞–≥–∏',
        'resource': '–†–µ—Å—É—Ä—Å—ã',
        'building': '–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ',
        'combat': '–ë–æ–π',
        'system': '–°–∏—Å—Ç–µ–º–∞',
        'negative': '–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–µ'
      };
      return labels[tag] || tag;
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
    window.markNotificationAsRead = function(id) {
      window.gameNotifications.markAsRead(id);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      const notificationElement = document.querySelector(`[data-id="${id}"]`);
      if (notificationElement) {
        notificationElement.classList.remove('unread');
        notificationElement.classList.add('read');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        const button = notificationElement.querySelector('.mark-read-btn');
        if (button) {
          button.textContent = '‚úì';
          button.disabled = true;
        }
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
      window.gameNotifications.updateNotificationCounter();
    };

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Phaser
    window.addGameNotification = function(message, type = 'info', day = null, tags = []) {
      window.gameNotifications.add(message, type, day, tags);
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è –∏–≥—Ä—ã
    window.getCurrentGameDay = function() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.dayNumber) {
          return gameScene.dayNumber;
        }
      }
      return 1; // fallback
    };

    window.openAbilities = function() {
      // Populate abilities and open modal
      if (typeof populateAbilitiesModal === 'function') {
        populateAbilitiesModal(null); // Will use sample data
      }
      openModal('abilities-modal');

      // Initialize weapon system when abilities modal is opened
      setTimeout(() => {
        if (window.initializeWeaponSystem) {
          window.initializeWeaponSystem();
        }
      }, 100);
    };

    // Weapon system functions
    window.currentWeapon = 'pistol';
    window.weaponDropdownVisible = false;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ä—É–∂–∏—è —Å GameScene
    window.syncWeaponWithGameScene = function(weaponType) {
      console.log(`[syncWeaponWithGameScene] Syncing weapon: ${weaponType}`);
      
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && typeof gameScene.setCurrentWeapon === 'function') {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –æ—Ä—É–∂–∏—è –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≤ ID –¥–ª—è GameScene
          let gameSceneWeaponType;
          switch (weaponType) {
            case 'pistol':
              gameSceneWeaponType = 'pistol';
              break;
            case 'shotgun':
              gameSceneWeaponType = 'shotgun';
              break;
            case 'assault_rifle':
              gameSceneWeaponType = 'ar';
              break;
            case 'sniper_rifle':
              gameSceneWeaponType = 'sniper';
              break;
            default:
              gameSceneWeaponType = 'pistol';
          }
          
          console.log(`[syncWeaponWithGameScene] Setting GameScene weapon to: ${gameSceneWeaponType}`);
          gameScene.setCurrentWeapon(gameSceneWeaponType);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ä—É–∂–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
          setTimeout(() => {
            const actualWeapon = gameScene.getCurrentWeapon();
            console.log(`[syncWeaponWithGameScene] GameScene weapon confirmed: ${actualWeapon}`);
          }, 50);
        } else {
          console.warn('[syncWeaponWithGameScene] GameScene or setCurrentWeapon not available');
        }
      } else {
        console.warn('[syncWeaponWithGameScene] window.game not available');
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ä—É–∂–∏—è –∏–∑ GameScene
    window.getCurrentWeaponFromGameScene = function() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && typeof gameScene.getCurrentWeapon === 'function') {
          const gameSceneWeapon = gameScene.getCurrentWeapon();
          console.log(`[getCurrentWeaponFromGameScene] GameScene weapon: ${gameSceneWeapon}`);
          return gameSceneWeapon;
        }
      }
      console.warn('[getCurrentWeaponFromGameScene] GameScene not available');
      return 'pistol'; // fallback
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ä—É–∂–∏—è –º–µ–∂–¥—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–º –∏ GameScene
    window.forceWeaponSync = function() {
      console.log('[forceWeaponSync] Forcing weapon synchronization');
      
      // –ü–æ–ª—É—á–∞–µ–º –æ—Ä—É–∂–∏–µ –∏–∑ GameScene
      const gameSceneWeapon = window.getCurrentWeaponFromGameScene();
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ ID –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
      let inventoryWeaponType;
      switch (gameSceneWeapon) {
        case 'pistol':
          inventoryWeaponType = 'pistol';
          break;
        case 'shotgun':
          inventoryWeaponType = 'shotgun';
          break;
        case 'ar':
          inventoryWeaponType = 'assault_rifle';
          break;
        case 'sniper':
          inventoryWeaponType = 'sniper_rifle';
          break;
        default:
          inventoryWeaponType = 'pistol';
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
      if (window.currentWeapon !== inventoryWeaponType) {
        console.log(`[forceWeaponSync] Updating inventory weapon from ${window.currentWeapon} to ${inventoryWeaponType}`);
        window.currentWeapon = inventoryWeaponType;
        window.updateWeaponDisplay(inventoryWeaponType);
      }
      
      console.log(`[forceWeaponSync] Weapon sync completed. Inventory: ${window.currentWeapon}, GameScene: ${gameSceneWeapon}`);
    };

    window.toggleWeaponDropdown = function() {
      const dropdown = document.getElementById('weapon-dropdown');
      if (dropdown) {
        window.weaponDropdownVisible = !window.weaponDropdownVisible;
        if (window.weaponDropdownVisible) {
          dropdown.classList.add('show');
          if (window.updateWeaponAvailability) window.updateWeaponAvailability();
        } else {
          dropdown.classList.remove('show');
        }
      }
    };

    window.selectWeapon = function(weaponType) {
      console.log(`[selectWeapon] Selecting weapon: ${weaponType}`);
      
      if (window.isWeaponAvailable && !window.isWeaponAvailable(weaponType)) {
        if (window.showToast) window.showToast('–≠—Ç–æ –æ—Ä—É–∂–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑—É—á–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏!');
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ—Ä—É–∂–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
      window.currentWeapon = weaponType;
      console.log(`[selectWeapon] Inventory weapon updated to: ${weaponType}`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
      if (window.updateWeaponDisplay) {
        window.updateWeaponDisplay(weaponType);
        console.log(`[selectWeapon] Weapon display updated in inventory`);
      }
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
      window.weaponDropdownVisible = false;
      const dropdown = document.getElementById('weapon-dropdown');
      if (dropdown) {
        dropdown.classList.remove('show');
      }

      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å GameScene
      if (window.syncWeaponWithGameScene) {
        window.syncWeaponWithGameScene(weaponType);
        console.log(`[selectWeapon] Weapon synced with GameScene`);
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (window.showToast) {
        const weaponName = window.getWeaponDisplayName ? window.getWeaponDisplayName(weaponType) : weaponType;
        let message = `–í—ã–±—Ä–∞–Ω–æ –æ—Ä—É–∂–∏–µ: ${weaponName}`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é –º–µ—Ö–∞–Ω–∏–∫—É –¥–ª—è —à—Ç—É—Ä–º–æ–≤–æ–π –≤–∏–Ω—Ç–æ–≤–∫–∏
        if (weaponType === 'assault_rifle') {
          message += '\n–ö–ª–∏–∫ - –æ–¥–∏–Ω–æ—á–Ω—ã–π –≤—ã—Å—Ç—Ä–µ–ª, —É–¥–µ—Ä–∂–∏–≤–∞–Ω–∏–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–≥–æ–Ω—å (3 –≤—ã—Å—Ç—Ä–µ–ª–∞/—Å–µ–∫)';
        }
        
        window.showToast(message);
      }
      
      console.log(`[selectWeapon] Weapon selection completed for: ${weaponType}`);
    };

    window.getWeaponData = function(weaponType) {
      const weapons = {
        pistol: {
          name: '–ü–∏—Å—Ç–æ–ª–µ—Ç',
          icon: 'src/sprites/guns/img/pistol.png',
          damage: 1,
          ammoType: 'pistol'
        },
        shotgun: {
          name: '–î—Ä–æ–±–æ–≤–∏–∫',
          icon: 'src/sprites/guns/img/shotgun.png',
          damage: 2,
          ammoType: 'shotgun'
        },
        assault_rifle: {
          name: '–®—Ç—É—Ä–º–æ–≤–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞',
          icon: 'src/sprites/guns/img/assault_rifle.png',
          damage: 1,
          ammoType: 'assault_rifle'
        },
        sniper_rifle: {
          name: '–°–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –≤–∏–Ω—Ç–æ–≤–∫–∞',
          icon: 'src/sprites/guns/img/sniper_rifle.png',
          damage: 3,
          ammoType: 'sniper_rifle'
        }
      };

      return weapons[weaponType] || weapons.pistol;
    };

    window.getWeaponDisplayName = function(weaponType) {
      const weaponData = window.getWeaponData(weaponType);
      return weaponData.name;
    };

    window.isWeaponAvailable = function(weaponType) {
      if (weaponType === 'pistol') return true;

      if (typeof window.getAbilitiesData === 'function') {
        try {
          const abilitiesData = window.getAbilitiesData();
          if (abilitiesData && abilitiesData.abilitiesData) {
            const defenseAbilities = abilitiesData.abilitiesData.defense;
            if (Array.isArray(defenseAbilities)) {
              switch (weaponType) {
                case 'shotgun':
                  const shotgunAbility = defenseAbilities.find(ability => ability.id === 'def_shotgun');
                  return shotgunAbility && shotgunAbility.currentLevel > 0;
                case 'assault_rifle':
                  const assaultRifleAbility = defenseAbilities.find(ability => ability.id === 'def_assault_rifle');
                  return assaultRifleAbility && assaultRifleAbility.currentLevel > 0;
                case 'sniper_rifle':
                  const sniperRifleAbility = defenseAbilities.find(ability => ability.id === 'def_sniper_rifle');
                  return sniperRifleAbility && sniperRifleAbility.currentLevel > 0;
                default:
                  return false;
              }
            }
          }
        } catch (error) {
          console.warn('Error checking weapon availability:', error);
        }
      }

      return false;
    };

    window.updateWeaponDisplay = function(weaponType) {
      const icon = document.getElementById('current-weapon-icon');
      const name = document.getElementById('current-weapon-name');
      const weaponSlot = document.querySelector('.weapon-slot');

      if (icon && name && weaponSlot) {
        const weaponData = window.getWeaponData(weaponType);
        icon.src = weaponData.icon;
        icon.alt = weaponData.name;
        name.textContent = weaponData.name;
        weaponSlot.setAttribute('data-current-weapon', weaponType);
      }
    };

    window.updateWeaponAvailability = function() {
      const weaponOptions = document.querySelectorAll('.weapon-option');

      weaponOptions.forEach(option => {
        const weaponType = option.dataset.weapon;
        const isAvailable = window.isWeaponAvailable(weaponType);

        if (isAvailable) {
          option.classList.remove('locked');
          const status = option.querySelector('.weapon-option-status');
          if (status) {
            status.textContent = '‚úì';
            status.className = 'weapon-option-status available';
          }
        } else {
          option.classList.add('locked');
          const status = option.querySelector('.weapon-option-status');
          if (status) {
            status.textContent = 'üîí';
            status.className = 'weapon-option-status locked';
          }
        }
      });
    };

    window.initializeWeaponSystem = function() {
      console.log('[initializeWeaponSystem] Starting weapon system initialization');
      
      // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å GameScene, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && typeof gameScene.getCurrentWeapon === 'function') {
          const gameSceneWeapon = gameScene.getCurrentWeapon();
          console.log(`[initializeWeaponSystem] GameScene weapon: ${gameSceneWeapon}`);
          
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º ID –æ—Ä—É–∂–∏—è –∏–∑ GameScene –≤ ID –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
          let inventoryWeaponType;
          switch (gameSceneWeapon) {
            case 'pistol':
              inventoryWeaponType = 'pistol';
              break;
            case 'shotgun':
              inventoryWeaponType = 'shotgun';
              break;
            case 'ar':
              inventoryWeaponType = 'assault_rifle';
              break;
            case 'sniper':
              inventoryWeaponType = 'sniper_rifle';
              break;
            default:
              inventoryWeaponType = 'pistol';
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –æ—Ä—É–∂–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
          if (inventoryWeaponType !== window.currentWeapon) {
            console.log(`[initializeWeaponSystem] Syncing inventory weapon from ${window.currentWeapon} to ${inventoryWeaponType}`);
            window.currentWeapon = inventoryWeaponType;
          }
        } else {
          console.log('[initializeWeaponSystem] GameScene not available, using default weapon');
        }
      } else {
        console.log('[initializeWeaponSystem] window.game not available, using default weapon');
      }
      
      console.log(`[initializeWeaponSystem] Final inventory weapon: ${window.currentWeapon}`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
      window.updateWeaponDisplay(window.currentWeapon);
      window.updateWeaponAvailability();
      
      console.log('[initializeWeaponSystem] Weapon system initialization completed');
    };

    // –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –∂—É—Ä–Ω–∞–ª–∞
    window.gameNotifications = {
      notifications: [],
      maxDays: 3,
      
      // –î–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      add: function(message, type = 'info', day = null, tags = []) {
        const currentDay = day || (window.game && window.game.scene ? 
          window.game.scene.getScene('Game')?.dayNumber || 1 : 1);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ —Ç–∏–ø–∞
        const autoTags = this.autoDetectTags(message, type);
        const allTags = [...new Set([...tags, ...autoTags])];
        
        const notification = {
          id: Date.now() + Math.random(),
          message: message,
          type: type, // 'info', 'success', 'warning', 'error'
          day: currentDay,
          timestamp: new Date().toLocaleTimeString(),
          read: false,
          tags: allTags
        };
        
        this.notifications.push(notification);
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–Ω–∏
        this.cleanupOldDays();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        this.showToast(message, type);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        this.updateNotificationCounter();
        

      },
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      autoDetectTags: function(message, type) {
        const tags = [];
        const lowerMessage = message.toLowerCase();

        // –ú–µ—Ç–∫–∏ –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è
        if (type === 'error') {
          tags.push('combat', 'negative');
        }
        if (type === 'warning') {
          tags.push('negative');
        }

        // –ú–µ—Ç–∫–∏ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—è
        if (lowerMessage.includes('–∂–∏—Ç–µ–ª—å') || lowerMessage.includes('–ø–æ—Å–µ—Ç–∏—Ç–µ–ª—å') || lowerMessage.includes('–ø—Ä–∏–Ω—è—Ç') || lowerMessage.includes('–æ—Ç–∫–∞–∑–∞–Ω–æ')) {
          tags.push('resident');
        }
        if (lowerMessage.includes('–≤—Ä–∞–≥') || lowerMessage.includes('–º–∞—Ä–æ–¥–µ—Ä') || lowerMessage.includes('–∑–æ–º–±–∏') || lowerMessage.includes('–º—É—Ç–∞–Ω—Ç') || lowerMessage.includes('—Å–æ–ª–¥–∞—Ç')) {
          tags.push('enemy');
        }
        if (lowerMessage.includes('–µ–¥–∞') || lowerMessage.includes('–≤–æ–¥–∞') || lowerMessage.includes('–ø–∞—Ç—Ä–æ–Ω') || lowerMessage.includes('–¥–µ–Ω—å–≥–∏') || lowerMessage.includes('—Ä–µ—Å—É—Ä—Å')) {
          tags.push('resource');
        }
        if (lowerMessage.includes('–∫–æ–º–Ω–∞—Ç–∞') || lowerMessage.includes('–ø–æ—Å—Ç—Ä–æ–µ–Ω–∞') || lowerMessage.includes('—É–Ω–∏—á—Ç–æ–∂–µ–Ω–∞') || lowerMessage.includes('—Å–∫–ª–∞–¥')) {
          tags.push('building');
        }
        if (lowerMessage.includes('—É–±–∏–ª') || lowerMessage.includes('–ø–æ–≥–∏–±') || lowerMessage.includes('–∞—Ç–∞–∫–∞') || lowerMessage.includes('–±–æ–π')) {
          tags.push('combat');
        }
        if (lowerMessage.includes('–¥–µ–Ω—å') || lowerMessage.includes('–Ω–æ—á—å') || lowerMessage.includes('—É—Ä–æ–≤–µ–Ω—å') || lowerMessage.includes('–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å')) {
          tags.push('system');
        }

        return tags;
      },
      
      // –ü–æ–∫–∞–∑–∞—Ç—å toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      showToast: function(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast-notification toast-${type}`;
        toast.textContent = message;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        let bgColor, textColor;
        switch (type) {
          case 'success':
            bgColor = 'rgba(76, 175, 80, 0.9)'; // –ó–µ–ª–µ–Ω—ã–π
            textColor = 'white';
            break;
          case 'warning':
            bgColor = 'rgba(255, 152, 0, 0.9)'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            textColor = 'white';
            break;
          case 'error':
            bgColor = 'rgba(244, 67, 54, 0.9)'; // –ö—Ä–∞—Å–Ω—ã–π
            textColor = 'white';
            break;
          default:
            bgColor = 'rgba(0, 0, 0, 0.9)'; // –ß–µ—Ä–Ω—ã–π
            textColor = 'white';
        }
        
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${bgColor};
          color: ${textColor};
          padding: 12px 20px;
          border-radius: 8px;
          z-index: 10000;
          font-size: 14px;
          font-weight: 500;
          pointer-events: none;
          opacity: 0;
          transition: all 0.3s ease;
          max-width: 400px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          transform: translateX(100%);
        `;

        document.body.appendChild(toast);

        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
          toast.style.opacity = '1';
          toast.style.transform = 'translateX(0)';
        }, 10);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (toast.parentNode) {
              toast.parentNode.removeChild(toast);
            }
          }, 300);
        }, 4000);
      },
      
      // –û—á–∏—Å—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—à–µ maxDays
      cleanupOldDays: function() {
        if (!window.game || !window.game.scene) return;
        
        const gameScene = window.game.scene.getScene('Game');
        if (!gameScene || !gameScene.dayNumber) return;
        
        const currentDay = gameScene.dayNumber;
        const cutoffDay = currentDay - this.maxDays;
        
        this.notifications = this.notifications.filter(n => n.day > cutoffDay);

      },
      
      // –ü–æ–ª—É—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –¥–Ω—è
      getByDay: function(day) {
        return this.notifications.filter(n => n.day === day);
      },
      
      // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      getAll: function() {
        return this.notifications.slice().reverse(); // –ù–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É
      },
      
      // –û—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
      markAsRead: function(id) {
        const notification = this.notifications.find(n => n.id === id);
        if (notification) {
          notification.read = true;
        }
      },
      
      // –ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      getUnreadCount: function() {
        return this.notifications.filter(n => !n.read).length;
      },
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      updateNotificationCounter: function() {
        const counter = document.getElementById('notification-counter');
        if (counter) {
          const count = this.getUnreadCount();
          counter.textContent = count > 0 ? count : '';
          counter.style.display = count > 0 ? 'block' : 'none';
        }
      },
      
      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º
      applyFilters: function(notifications) {
        const activeTags = window.getActiveTagFilters();
        const activeTypes = window.getActiveTypeFilters();

        const filtered = notifications.filter(notification => {
          // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É - –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Ç–∏–ø—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
          if (activeTypes.length > 0) {
            if (!activeTypes.includes(notification.type)) {
              return false;
            }
          }

          // –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç–∫–∞–º - –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –º–µ—Ç–∫–∞–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
          if (activeTags.length > 0) {
            const hasMatchingTag = notification.tags && notification.tags.some(tag => activeTags.includes(tag));
            if (!hasMatchingTag) {
              return false;
            }
          }

          return true;
        });

        return filtered;
      },
      
      // –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–Ω—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
      markAllDayAsRead: function(day) {
        const targetDay = day || window.getCurrentGameDay();
        this.notifications.forEach(notification => {
          if (notification.day === targetDay) {
            notification.read = true;
          }
        });
        this.updateNotificationCounter();
        window.populateJournalModal();
      }
    };

    // –ê–ª–∏–∞—Å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    window.showToast = function(message, type = 'info') {
      window.gameNotifications.showToast(message, type);
    };

    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –º–µ—Ç–∫–∞–º
    if (!window.activeTagFilters) {
      window.activeTagFilters = [];
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∂—É—Ä–Ω–∞–ª–∞
    window.getActiveTagFilters = function() {
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –º–∞—Å—Å–∏–≤ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (!window.activeTagFilters) {
        window.activeTagFilters = [];
      }
      return window.activeTagFilters;
    };

        window.getActiveTypeFilters = function() {
      const activeFilters = [];
      const typeFilters = document.querySelectorAll('.type-filters input[type="checkbox"]:checked');
      const allCheckbox = document.querySelector('.type-filters input[value="all"]');

      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω "–í—Å–µ", –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ç–∏–ø—ã)
      if (allCheckbox && allCheckbox.checked) {
        return [];
      }

      // –ò–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–∏–ø—ã
      typeFilters.forEach(filter => {
        if (filter.value !== 'all') {
          activeFilters.push(filter.value);
        }
      });

      return activeFilters;
    };

        window.toggleTagFilter = function(tag) {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (!window.activeTagFilters) {
        window.activeTagFilters = [];
      }

      const filterElement = document.querySelector(`[data-tag="${tag}"]`);
      if (filterElement) {
        const wasActive = filterElement.classList.contains('active');
        filterElement.classList.toggle('active');
        const isActive = filterElement.classList.contains('active');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        if (isActive) {
          if (!window.activeTagFilters.includes(tag)) {
            window.activeTagFilters.push(tag);
          }
        } else {
          window.activeTagFilters = window.activeTagFilters.filter(t => t !== tag);
        }

        window.populateJournalModal();
      }
    };

    window.markAllDayAsRead = function() {
      const currentDay = window.getCurrentGameDay();
      window.gameNotifications.markAllDayAsRead(currentDay);
    };

        window.clearAllFilters = function() {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –º–µ—Ç–∫–∞–º
      if (!window.activeTagFilters) {
        window.activeTagFilters = [];
      }
      window.activeTagFilters = [];

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –º–µ—Ç–∫–∞–º –≤ DOM
      const activeTagFilters = document.querySelectorAll('.tag-filter.active');
      activeTagFilters.forEach(filter => {
        filter.classList.remove('active');
      });

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–∏–ø—É
      const typeCheckboxes = document.querySelectorAll('.type-filters input[type="checkbox"]');
      typeCheckboxes.forEach(checkbox => {
        checkbox.checked = true;
      });

      window.populateJournalModal();
    };



    window.initializeTagFilters = function() {
      const tagFiltersContainer = document.getElementById('tag-filters');
      if (!tagFiltersContainer) {
        return;
      }

      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const previouslyActiveTags = window.activeTagFilters;

      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      const allTags = new Set();
      const notifications = window.gameNotifications.getAll();

      notifications.forEach(notification => {
        if (notification.tags) {
          notification.tags.forEach(tag => allTags.add(tag));
        }
      });

      // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –º–µ—Ç–∫–∏
      tagFiltersContainer.innerHTML = '';
      Array.from(allTags).sort().forEach(tag => {
        const filterElement = document.createElement('div');
        filterElement.className = 'tag-filter';
        filterElement.dataset.tag = tag;
        filterElement.textContent = window.getTagLabel(tag);

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
        if (previouslyActiveTags.includes(tag)) {
          filterElement.classList.add('active');
        }

        filterElement.onclick = (event) => {
          event.stopPropagation();
          window.toggleTagFilter(tag);
        };
        tagFiltersContainer.appendChild(filterElement);
      });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ —Ç–∏–ø—É —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(() => {
        const typeFilters = document.querySelectorAll('.type-filters input[type="checkbox"]');

        if (typeFilters.length === 0) {
          setTimeout(() => {
            const retryTypeFilters = document.querySelectorAll('.type-filters input[type="checkbox"]');
            setupTypeFilterHandlers(retryTypeFilters);
          }, 100);
          return;
        }

        setupTypeFilterHandlers(typeFilters);
      }, 50);

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
      function setupTypeFilterHandlers(typeFilters) {
        typeFilters.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            // –ï—Å–ª–∏ —Å–Ω—è–ª–∏ –≥–∞–ª–æ—á–∫—É —Å "–í—Å–µ", —É–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            if (checkbox.value === 'all' && !checkbox.checked) {
              typeFilters.forEach(cb => {
                if (cb.value !== 'all') {
                  cb.checked = false;
                }
              });
            }
            // –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –≥–∞–ª–æ—á–∫—É –Ω–∞ "–í—Å–µ", —É–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            if (checkbox.value === 'all' && checkbox.checked) {
              typeFilters.forEach(cb => {
                if (cb.value !== 'all') {
                  cb.checked = false;
                }
              });
            }
            // –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –≥–∞–ª–æ—á–∫—É –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ç–∏–ø, —É–±–∏—Ä–∞–µ–º "–í—Å–µ"
            if (checkbox.value !== 'all' && checkbox.checked) {
              const allCheckbox = document.querySelector('.type-filters input[value="all"]');
              if (allCheckbox) {
                allCheckbox.checked = false;
              }
            }
            // –ï—Å–ª–∏ —Å–Ω—è–ª–∏ –≤—Å–µ –≥–∞–ª–æ—á–∫–∏, —Å—Ç–∞–≤–∏–º "–í—Å–µ"
            const checkedTypes = Array.from(typeFilters).filter(cb => cb.checked);
            if (checkedTypes.length === 0) {
              const allCheckbox = document.querySelector('.type-filters input[value="all"]');
              if (allCheckbox) {
                allCheckbox.checked = true;
              }
            }

            window.populateJournalModal();
          });
        });
      }
    };

    // Close weapon dropdown when clicking outside
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(event) {
        const weaponSlot = document.querySelector('.weapon-slot');
        const dropdown = document.getElementById('weapon-dropdown');

        if (weaponSlot && dropdown && !weaponSlot.contains(event.target)) {
          if (window.weaponDropdownVisible !== undefined) {
            window.weaponDropdownVisible = false;
          }
          if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });
    });

    window.openRoomSelection = function() {
      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º
      setTimeout(() => {
        // Populate room selection and open modal
        if (typeof populateRoomSelectionModal === 'function') {
          // –ü–æ–ª—É—á–∞–µ–º GameScene –∏–∑ window.game
          let gameScene = null;
          if (window.game && window.game.scene) {
            console.log('[HTML] Available scenes:', window.game.scene.scenes.map(s => s.scene.key));
            
            // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–º–µ–Ω —Å—Ü–µ–Ω—ã
            gameScene = window.game.scene.getScene('GameScene') || 
                       window.game.scene.getScene('Game');
            
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –ø–æ –∏–º–µ–Ω–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é —Å—Ü–µ–Ω—É Game
            if (!gameScene) {
              const gameScenes = window.game.scene.scenes.filter(s => s.scene.key === 'Game');
              if (gameScenes.length > 0) {
                gameScene = gameScenes[0];
              }
            }
            
            console.log('[HTML] Found gameScene:', !!gameScene);
          }
          populateRoomSelectionModal(gameScene);
        }
        openModal('room-selection-modal');
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
        window.lastRoomModalOpenTime = Date.now();
      }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ 100–º—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞
    };

    window.togglePause = function() {
      // Open menu modal instead of just pausing
      openModal('menu-modal');
    };

    window.openResidents = function() {
      console.log('=== OPENING RESIDENTS MODAL ===');
      console.log('window.game exists:', !!window.game);
      console.log('window.game.scene exists:', !!(window.game && window.game.scene));

      // Get real data from game scene
      let residents = [];
      if (window.game && window.game.scene) {
        try {
          const gameScene = window.game.scene.getScene('Game');
          console.log('Game scene found:', !!gameScene);

          if (gameScene) {
            // Try to use the new method first
            if (typeof gameScene.getCurrentResidentsData === 'function') {
              residents = gameScene.getCurrentResidentsData();
              console.log('Got residents using getCurrentResidentsData method');
            } else {
              // Fallback to manual data collection
              const rawResidents = gameScene.bunkerResidents || [];
              console.log('Raw residents from game:', rawResidents);
              console.log('Raw residents count:', rawResidents.length);

              residents = rawResidents.map((resident, index) => ({
                id: resident.id,
                index: index,
                name: resident.name,
                age: resident.age,
                gender: resident.gender,
                profession: resident.profession,
                status: resident.status || '–û—Ç–¥—ã—Ö–∞–µ—Ç',
                hunger: resident.hunger || 100,
                thirst: resident.thirst || 100,
                energy: resident.energy || 100,
                health: resident.health || 100,
                skills: resident.skills || [],
                itemsText: resident.itemsText || '–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤',
                admittedAt: resident.admittedAt,
                patient: resident.patient || false,
                isEnemy: false
              }));

              console.log('Formatted residents count:', residents.length);
            }

            if (residents.length > 0) {
              console.log('First resident sample:', residents[0]);
            } else {
              console.warn('No residents found in bunker');
            }
          } else {
            console.error('Game scene not found!');
          }
        } catch (error) {
          console.error('Error getting residents data:', error);
        }
      } else {
        console.warn('window.game or window.game.scene not available');
        console.log('Available window properties:', Object.keys(window).filter(k => k.includes('game')));
      }

      // Store residents data globally for detail view
      window.currentResidentsData = residents;
      console.log('Stored residents data count:', residents.length);

      // If no residents found, try to get them from bunkerView
      if (residents.length === 0 && window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.simpleBunker) {
          console.log('Trying to get residents from bunkerView...');
          // Some residents might be managed by bunkerView
        }
      }

      // Populate modal with data
      if (typeof window.populatePopulationModal === 'function') {
        console.log('Calling populatePopulationModal with', residents.length, 'residents');
        window.populatePopulationModal(residents);
      } else {
        console.error('populatePopulationModal function not found');
      }

      // Open modal
      if (typeof window.openModal === 'function') {
        console.log('Opening population-modal');
        window.openModal('population-modal');
      } else {
        console.error('openModal function not found');
      }

      console.log('=== RESIDENTS MODAL OPENING COMPLETE ===');
    };

    window.openResource = function(resource) {
      console.log('Opening resource modal:', resource);

      // Get resource data from game or use defaults
      let gameData = {
        happiness: 50,
        defense: 50,
        ammo: 100,
        comfort: 100,
        food: 100,
        water: 100,
        money: 200,
        population: 0
      };

      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          gameData = {
            happiness: gameScene.happiness || 50,
            defense: gameScene.defense || 50,
            ammo: gameScene.ammo || 100,
            comfort: gameScene.comfort || 100,
            food: gameScene.food || 100,
            water: gameScene.water || 100,
            money: gameScene.money || 200,
            population: gameScene.bunkerResidents ? gameScene.bunkerResidents.length : 0
          };
        }
      }

      // Populate modal with data
      if (typeof window.populateResourceModal === 'function') {
        window.populateResourceModal(resource, gameData);
      }

      // Open modal
      if (typeof window.openModal === 'function') {
        window.openModal('resource-modal');
      }
    };

    window.openEnemies = function() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          const enemyCount = gameScene.bunkerEnemies ? gameScene.bunkerEnemies.length : 0;
          gameScene.showToast(`Enemies: ${enemyCount}`);
        }
      }
    };

    // Phaser scene interaction control
    let phaserSceneDisabled = false;

    window.disablePhaserInteractions = function() {
      if (phaserSceneDisabled) return;

      phaserSceneDisabled = true;

      // Get the game scene
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          // Disable input on the scene
          gameScene.input.enabled = false;

          // Disable input on all interactive objects
          gameScene.input.manager.globalTopOnly = true;

          console.log('[ModalManager] Phaser interactions disabled');
        }
      } else {
        console.warn('[ModalManager] Game scene not available, cannot disable interactions');
      }
    };

    window.enablePhaserInteractions = function() {
      if (!phaserSceneDisabled) return;

      phaserSceneDisabled = false;

      // Get the game scene
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          // Re-enable input on the scene
          gameScene.input.enabled = true;

          // Restore normal input behavior
          gameScene.input.manager.globalTopOnly = false;

          console.log('[ModalManager] Phaser interactions enabled');
        }
      } else {
        console.warn('[ModalManager] Game scene not available, cannot enable interactions');
      }
    };

    // Modal management functions
        window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.style.display = 'none';

        // Remove overlay click handler if it exists
        if (modal._overlayClickHandler) {
          modal.removeEventListener('click', modal._overlayClickHandler);
          delete modal._overlayClickHandler;
        }

        // Special handling for abilities modal
        if (modalId === 'abilities-modal') {
          clearAbilityTree();
        }

        // Re-enable Phaser interactions when modal closes
        setTimeout(() => {
          window.enablePhaserInteractions();
        }, 100); // Small delay to ensure modal is fully closed
      }
    };

    window.openModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        // Disable Phaser interactions when modal opens
        window.disablePhaserInteractions();

        modal.style.display = 'block';

        // Add click handler to close modal when clicking on overlay
        const handleOverlayClick = function(event) {
          // Only close if clicked directly on the modal overlay, not on modal content
          if (event.target === modal) {
            window.closeModal(modalId);
          }
        };

        // Store the handler for later removal
        modal._overlayClickHandler = handleOverlayClick;
        modal.addEventListener('click', handleOverlayClick);
      }
    };

    // Population modal functions
    window.populatePopulationModal = function(residents) {
      const container = document.getElementById('population-list');
      if (!container) return;

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∏—Ç–µ–ª–µ–π
      window.showPopulationList();

      container.innerHTML = '';

      if (residents && residents.length > 0) {
        residents.forEach((resident, index) => {
          const residentDiv = document.createElement('div');
          residentDiv.className = 'resident-item';
          residentDiv.onclick = () => openResidentDetail(index);
          residentDiv.style.cursor = 'pointer';
          residentDiv.style.transition = 'all 0.2s ease';

          // Add hover effect
          residentDiv.onmouseover = () => {
            residentDiv.style.background = '#3a3a3a';
            residentDiv.style.borderColor = '#D4AF37';
          };
          residentDiv.onmouseout = () => {
            residentDiv.style.background = '#2a2a2a';
            residentDiv.style.borderColor = '#555555';
          };

          residentDiv.innerHTML = `
            <div class="resident-info">
              <div class="resident-name">${resident.name}</div>
              <div class="resident-profession">${resident.profession}</div>
            </div>
          `;

          container.appendChild(residentDiv);
        });
      } else {
        container.innerHTML = '<p style="text-align: center; color: #888;">–í –±—É–Ω–∫–µ—Ä–µ –ø–æ–∫–∞ –Ω–µ—Ç –∂–∏—Ç–µ–ª–µ–π</p>';
      }
    };

    window.openResidentDetail = function(index) {
      console.log('Opening resident detail for index:', index);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∂–∏—Ç–µ–ª—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ revealHiddenSkill
      window.currentResidentIndex = index;

      // Get resident data from stored residents
      let resident = window.currentResidentsData ? window.currentResidentsData[index] : null;

      if (!resident) {
        console.error('Resident not found at index:', index);
        return;
      }

      // Sync with real-time data from Phaser
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          // Try to get fresh data using the new method
          if (typeof gameScene.getResidentById === 'function') {
            const freshData = gameScene.getResidentById(resident.id);
            if (freshData) {
              console.log('Got fresh data for resident:', freshData.name, 'health:', freshData.health);
              resident = { ...resident, ...freshData };
            }
          } else {
            // Fallback to manual sync
            if (gameScene.simpleBunker && gameScene.simpleBunker.residentAgents) {
              const agent = gameScene.simpleBunker.residentAgents.find(a => a.id === resident.id);
              if (agent && agent.health !== undefined) {
                console.log('Syncing health from bunkerView:', agent.health, 'for resident:', resident.name);
                resident.health = agent.health;
              }
            }

            // Also check if resident has updated data in bunkerResidents
            const updatedResident = gameScene.bunkerResidents.find(r => r.id === resident.id);
            if (updatedResident) {
              resident.hunger = updatedResident.hunger || 100;
              resident.thirst = updatedResident.thirst || 100;
              resident.energy = updatedResident.energy || 100;
              resident.health = updatedResident.health || 100;
              resident.status = updatedResident.status || '–û—Ç–¥—ã—Ö–∞–µ—Ç';
            }
          }
        }
      }

      console.log('Showing details for resident:', resident.name, 'health:', resident.health);

      // Populate resident detail content
      if (typeof window.populateResidentDetailModal === 'function') {
        window.populateResidentDetailModal(resident);
      }

      // Switch to resident detail view in the same modal
      window.showResidentDetail();
    };

    // Resident detail modal functions
    window.populateResidentDetailModal = function(resident) {
      const container = document.getElementById('resident-detail-content');
      if (!container) return;

      // Format skills - only first skill is visible, others are hidden
      const skillsList = resident.skills && resident.skills.length > 0
        ? resident.skills.map((skill, index) => {
            if (index === 0) {
              // First skill - fully visible
              return `<div class="skill-item ${skill.positive ? 'positive' : 'negative'}">
                <span class="skill-text">${skill.text}</span>
                <span class="skill-effect">${skill.positive ? '‚úì' : '‚úó'}</span>
              </div>`;
            } else {
              // Hidden skills - show as "???" with click to reveal
              return `<div class="skill-item hidden-skill" data-skill-index="${index}" onclick="revealHiddenSkill(this, ${index})">
                <span class="skill-text">???</span>
                <span class="skill-effect">?</span>
              </div>`;
            }
          }).join('')
        : '<div class="no-skills">–ù–µ—Ç –Ω–∞–≤—ã–∫–æ–≤</div>';

      // Create resident detail HTML
      container.innerHTML = `
        <div class="resident-details">
          <div class="detail-section main-info">
            <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="label">–ò–º—è:</span>
                <span class="value">${resident.name}</span>
              </div>
              <div class="detail-item">
                <span class="label">–í–æ–∑—Ä–∞—Å—Ç:</span>
                <span class="value">${resident.age} –ª–µ—Ç</span>
              </div>
              <div class="detail-item">
                <span class="label">–ü–æ–ª:</span>
                <span class="value">${resident.gender === '–ú' ? '–ú—É–∂—Å–∫–æ–π' : '–ñ–µ–Ω—Å–∫–∏–π'}</span>
              </div>
              <div class="detail-item">
                <span class="label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</span>
                <span class="value">${resident.profession}</span>
              </div>
              <div class="detail-item">
                <span class="label">–°—Ç–∞—Ç—É—Å:</span>
                <span class="value">${resident.status}</span>
              </div>
              <div class="detail-item">
                <span class="label">–í –±—É–Ω–∫–µ—Ä–µ —Å:</span>
                <span class="value">–î–µ–Ω—å ${resident.admittedAt || 1}</span>
              </div>
            </div>
          </div>

          <div class="detail-section status-info">
            <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
            <div class="status-meters">
              <div class="status-meter">
                <div class="meter-label">–ó–¥–æ—Ä–æ–≤—å–µ</div>
                <div class="meter-bar">
                  <div class="meter-fill health" style="width: ${resident.health}%"></div>
                </div>
                <span class="meter-value">${Math.round(resident.health)}%</span>
              </div>
            </div>
          </div>

          ${resident.skills && resident.skills.length > 0 ? `
            <div class="detail-section skills-info">
              <h3>–ù–∞–≤—ã–∫–∏</h3>
              <div class="skills-grid">
                ${skillsList}
              </div>
            </div>
          ` : ''}

          <div class="detail-section inventory-info">
            <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <p>${resident.itemsText}</p>
          </div>
        </div>
      `;
    };

    // Resource modal functions
    window.populateResourceModal = function(resourceType, data) {
      const title = document.getElementById('resource-modal-title');
      const content = document.getElementById('resource-modal-content');

      if (!title || !content) return;

      title.textContent = resourceType.toUpperCase();

      let details = '';

      switch(resourceType.toLowerCase()) {
        case 'happiness':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.happiness}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–£—Ä–æ–≤–µ–Ω—å –∫–æ–º—Ñ–æ—Ä—Ç–∞, –Ω–∞–ª–∏—á–∏–µ —Ä–∞–±–æ—Ç—ã, –∑–¥–æ—Ä–æ–≤—å–µ</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–î–æ–≤–æ–ª—å—Å—Ç–≤–æ –∂–∏—Ç–µ–ª–µ–π, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞, –±—É–Ω—Ç—ã</span>
              </div>
              <div class="resource-description">
                <p>–°—á–∞—Å—Ç—å–µ –∂–∏—Ç–µ–ª–µ–π –≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å. –ù–∏–∑–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å—á–∞—Å—Ç—å—è –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±—É–Ω—Ç–∞–º –∏ —Å–Ω–∏–∂–µ–Ω–∏—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã.</p>
              </div>
            </div>
          `;
          break;

        case 'defense':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.defense}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</span>
                <span>5 –µ–¥–∏–Ω–∏—Ü –≤ –¥–µ–Ω—å</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–ù–∞–ª–∏—á–∏–µ —É–∫—Ä–µ–ø–ª–µ–Ω–∏–π, –æ—Ä—É–∂–∏—è, –æ–±—É—á–µ–Ω–Ω—ã—Ö –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –≤–Ω—É—Ç—Ä—å –±—É–Ω–∫–µ—Ä–∞</span>
              </div>
              <div class="resource-description">
                <p>–ó–∞—â–∏—Ç–∞ –±—É–Ω–∫–µ—Ä–∞ –≤–∫–ª—é—á–∞–µ—Ç —É–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å—Ç–µ–Ω, –≤–æ–æ—Ä—É–∂–µ–Ω–∏–µ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∂–∏—Ç–µ–ª–µ–π –∫ –æ–±–æ—Ä–æ–Ω–µ. –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ —É—Å–ø–µ—à–Ω—ã—Ö –∞—Ç–∞–∫ –≤—Ä–∞–≥–æ–≤.</p>
              </div>
            </div>
          `;
          break;

        case 'ammo':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ä–æ–Ω–æ–≤</span>
                <span>${data.ammo} —à—Ç.</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ç—Ä–æ–Ω–æ–≤ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–ü–∞—Ç—Ä–æ–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∑–∞—â–∏—Ç—ã –±—É–Ω–∫–µ—Ä–∞ –æ—Ç –≤—Ä–∞–≥–æ–≤ –∏ –æ—Ö–æ—Ç—ã. –ò—Ö –∑–∞–ø–∞—Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤ –æ–ø–∞—Å–Ω–æ–º –º–∏—Ä–µ.</p>
              </div>
            </div>
          `;
          break;

        case 'food':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.food} –µ–¥–∏–Ω–∏—Ü</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–ï–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω—ã–º —Ä–µ—Å—É—Ä—Å–æ–º –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∂–∏–∑–Ω–∏ –∂–∏—Ç–µ–ª–µ–π. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –µ–¥—ã –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –≥–æ–ª–æ–¥—É –∏ —Å–Ω–∏–∂–µ–Ω–∏—é –∑–¥–æ—Ä–æ–≤—å—è.</p>
              </div>
            </div>
          `;
          break;

        case 'water':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.water} –µ–¥–∏–Ω–∏—Ü</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–í–æ–¥–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è. –ï—ë –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏—é –∏ —Å–º–µ—Ä—Ç–∏ –∂–∏—Ç–µ–ª–µ–π.</p>
              </div>
            </div>
          `;
          break;

        case 'money':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>
                <span>${data.money} –º–æ–Ω–µ—Ç</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–†–∞—Å—Ö–æ–¥ –Ω–∞ –∂–∏—Ç–µ–ª—è –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç —Ä–∞–±–æ—Ç—ã –≤ –¥–µ–Ω—å</span>
                <span>–ó–∞–≥–ª—É—à–∫–∞</span>
              </div>
              <div class="resource-description">
                <p>–î–µ–Ω—å–≥–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤, –Ω–∞–π–º–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏—è –±—É–Ω–∫–µ—Ä–∞. –û–Ω–∏ —Ç–∞–∫–∂–µ –Ω—É–∂–Ω—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏.</p>
              </div>
            </div>
          `;
          break;

        case 'comfort':
          details = `
            <div class="resource-details">
              <div class="resource-stat positive">
                <span>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å</span>
                <span>${data.comfort}%</span>
              </div>
              <div class="resource-stat neutral">
                <span>–û—Ç —á–µ–≥–æ –∑–∞–≤–∏—Å–∏—Ç</span>
                <span>–ö–∞—á–µ—Å—Ç–≤–æ –ø–æ–º–µ—â–µ–Ω–∏–π, –Ω–∞–ª–∏—á–∏–µ —É–¥–æ–±—Å—Ç–≤, –æ—Å–≤–µ—â–µ–Ω–∏–µ</span>
              </div>
              <div class="resource-stat neutral">
                <span>–ù–∞ —á—Ç–æ –≤–ª–∏—è–µ—Ç</span>
                <span>–ü—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∂–∏—Ç–µ–ª–µ–π</span>
              </div>
              <div class="resource-description">
                <p>–ö–æ–º—Ñ–æ—Ä—Ç –≤–ª–∏—è–µ—Ç –Ω–∞ –º–æ—Ä–∞–ª—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ –∂–∏—Ç–µ–ª–µ–π. –•–æ—Ä–æ—à–∏–µ —É—Å–ª–æ–≤–∏—è –∂–∏–∑–Ω–∏ –ø–æ–≤—ã—à–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–Ω–∏–∂–∞—é—Ç —Ä–∏—Å–∫ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π.</p>
              </div>
            </div>
          `;
          break;

        default:
          details = '<p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—É—Ä—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
      }

      content.innerHTML = details;
    };

    // Menu functions
    window.continueGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∏–≥—Ä—É...');
        }
      }
    };

    window.saveGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
        }
      }
    };

    window.loadGame = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã... (WIP)');
        }
      }
    };

    window.openSettings = function() {
      closeModal('menu-modal');
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.showToast) {
          gameScene.showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ (WIP)');
        }
      }
    };

    window.exitToMenu = function() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é?')) {
        closeModal('menu-modal');
        if (window.game && window.game.scene) {
          const gameScene = window.game.scene.getScene('Game');
          if (gameScene && gameScene.showToast) {
            gameScene.showToast('–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é...');
          }
        }
      }
    };

    // Inventory functions
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ ID
    window.getItemById = function(id) {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ GameScene –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.getItemById) {
          return gameScene.getItemById(id);
        }
      }

      // Fallback: —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –µ—Å–ª–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      const fallbackItems = {
        'food': { id: 'food', name: '–ï–¥–∞', spritePath: 'src/sprites/items/food.png', description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ', price: 10 },
        'water': { id: 'water', name: '–í–æ–¥–∞', spritePath: 'src/sprites/items/water.png', description: '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –¥–ª—è –≤—ã–∂–∏–≤–∞–Ω–∏—è', price: 8 },
        'medicine': { id: 'medicine', name: '–õ–µ–∫–∞—Ä—Å—Ç–≤–æ', spritePath: 'src/sprites/items/medicine.png', description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ', price: 40 },
        'ammo': { id: 'ammo', name: '–ü–∞—Ç—Ä–æ–Ω—ã', spritePath: 'src/sprites/items/ammo.png', description: '–ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã –¥–ª—è –æ—Ä—É–∂–∏—è', price: 15 },
        'multi_tool': { id: 'multi_tool', name: '–ú—É–ª—å—Ç–∏—Ç—É–ª', spritePath: 'src/sprites/items/multi_tool.png', description: '–ù–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤', price: 75 },
        'flashlight': { id: 'flashlight', name: '–§–æ–Ω–∞—Ä–∏–∫', spritePath: 'src/sprites/items/flashlight.png', description: '–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞', price: 35 },
        'bottle': { id: 'bottle', name: '–ë—É—Ç—ã–ª–∫–∞', spritePath: 'src/sprites/items/bottle.png', description: '–ü—É—Å—Ç–∞—è –±—É—Ç—ã–ª–∫–∞', price: 5 },
        'compass': { id: 'compass', name: '–ö–æ–º–ø–∞—Å', spritePath: 'src/sprites/items/compass.png', description: '–ü–æ–º–æ–≥–∞–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è', price: 45 },
        'map': { id: 'map', name: '–ö–∞—Ä—Ç–∞', spritePath: 'src/sprites/items/map.png', description: '–ü–æ–º–æ–≥–∞–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è', price: 30 },
        'backpack': { id: 'backpack', name: '–†—é–∫–∑–∞–∫', spritePath: 'src/sprites/items/backpack.png', description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å', price: 50 },
        'battery': { id: 'battery', name: '–ë–∞—Ç–∞—Ä–µ–π–∫–∞', spritePath: 'src/sprites/items/battery.png', description: '–ò—Å—Ç–æ—á–Ω–∏–∫ —ç–Ω–µ—Ä–≥–∏–∏', price: 12 },
        'lighter': { id: 'lighter', name: '–ó–∞–∂–∏–≥–∞–ª–∫–∞', spritePath: 'src/sprites/items/lighter.png', description: '–î–ª—è —Ä–∞–∑–∂–∏–≥–∞–Ω–∏—è –æ–≥–Ω—è', price: 15 },
        'matches': { id: 'matches', name: '–°–ø–∏—á–∫–∏', spritePath: 'src/sprites/items/matches.png', description: '–î–ª—è —Ä–∞–∑–∂–∏–≥–∞–Ω–∏—è –æ–≥–Ω—è', price: 10 },
        'coal': { id: 'coal', name: '–£–≥–æ–ª—å', spritePath: 'src/sprites/items/coal.png', description: '–¢–æ–ø–ª–∏–≤–æ', price: 8 },
        'wood': { id: 'wood', name: '–î–µ—Ä–µ–≤–æ', spritePath: 'src/sprites/items/wood.png', description: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞', price: 12 },
        'metal': { id: 'metal', name: '–ú–µ—Ç–∞–ª–ª', spritePath: 'src/sprites/items/metal.png', description: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞', price: 20 },
        'glass': { id: 'glass', name: '–°—Ç–µ–∫–ª–æ', spritePath: 'src/sprites/items/glass.png', description: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∫—Ä–∞—Ñ—Ç–∞', price: 12 },
        'nails': { id: 'nails', name: '–ì–≤–æ–∑–¥–∏', spritePath: 'src/sprites/items/nails.png', description: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞', price: 10 },
        'tape': { id: 'tape', name: '–°–∫–æ—Ç—á', spritePath: 'src/sprites/items/tape.png', description: '–î–ª—è —Å–∫–ª–µ–∏–≤–∞–Ω–∏—è', price: 8 },
        'paper': { id: 'paper', name: '–ë—É–º–∞–≥–∞', spritePath: 'src/sprites/items/paper.png', description: '–ú–∞—Ç–µ—Ä–∏–∞–ª –¥–ª—è –∑–∞–ø–∏—Å–µ–π', price: 5 }
      };

      return fallbackItems[id] || null;
    };

    window.populateInventoryModal = function(inventory, inventoryRows = 1) {
      console.log(`[populateInventoryModal] Called with inventoryRows: ${inventoryRows}, inventory length: ${inventory ? inventory.length : 0}`);

      const grid = document.getElementById('inventory-grid');
      if (!grid) {
        console.log(`[populateInventoryModal] inventory-grid element not found`);
        return;
      }

      // Clear existing slots
      grid.innerHTML = '';

      // Create inventory slots (6 columns √ó inventoryRows)
      const totalSlots = 6 * inventoryRows;
      console.log(`[populateInventoryModal] Creating ${totalSlots} slots (6 columns √ó ${inventoryRows} rows)`);

      for (let i = 0; i < totalSlots; i++) {
        const slot = document.createElement('div');
        slot.className = 'inventory-slot';
        slot.onclick = () => selectInventorySlot(i);

        const item = inventory ? inventory[i] : null;
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–µ–¥–º–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—É—Å—Ç—ã–º
        if (item && item.id && item.id.trim() !== '' && item.quantity > 0) {
          slot.classList.add('occupied');

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –Ω–æ–≤—ã–π (—Å id) –∏–ª–∏ —Å—Ç–∞—Ä—ã–π (—Å icon)
          let itemDisplay = '';
          let itemQuantity = item.quantity || 1;

          if (item.id) {
            // –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: –∏—â–µ–º –ø—Ä–µ–¥–º–µ—Ç –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
            const itemData = window.getItemById(item.id);
            if (itemData) {
              itemDisplay = `<img src="${itemData.spritePath}" alt="${itemData.name}" style="width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated;">`;
            } else {
              itemDisplay = `‚ùì`; // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç
            }
          } else if (item.icon) {
            // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫—É
            itemDisplay = item.icon;
          } else {
            // Fallback
            itemDisplay = 'üì¶';
          }

          slot.innerHTML = `
            <div class="item">${itemDisplay}</div>
            <div class="quantity">${itemQuantity}</div>
          `;
        } else {
          // –ü—É—Å—Ç–æ–π —Å–ª–æ—Ç - –æ—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
          slot.classList.remove('occupied');
          slot.innerHTML = '';
        }

        grid.appendChild(slot);
      }

      console.log(`[populateInventoryModal] Successfully created ${totalSlots} inventory slots`);

      // Initialize drag and drop after creating slots
      setTimeout(() => {
        if (window.initializeInventoryDragAndDrop) {
          window.initializeInventoryDragAndDrop();
        }
      }, 100);
    };

    window.selectInventorySlot = function(index) {
      console.log('Selected inventory slot:', index);
      // This will be implemented for item interactions
    };

    // Drag and Drop functionality for inventory
    let draggedItem = null;
    let draggedItemIndex = -1;
    let dragGhost = null;
    let dropTarget = null;

    // Initialize drag and drop for inventory slots
    window.initializeInventoryDragAndDrop = function() {
      const slots = document.querySelectorAll('.inventory-slot');
      slots.forEach((slot, index) => {
        // Make slots draggable
        slot.draggable = true;

        // Drag start event
        slot.addEventListener('dragstart', function(e) {
          e.dataTransfer.effectAllowed = 'move';
          draggedItemIndex = index;
          draggedItem = slot.cloneNode(true);

          // Create drag ghost
          dragGhost = slot.cloneNode(true);
          dragGhost.style.position = 'absolute';
          dragGhost.style.opacity = '0.5';
          dragGhost.style.pointerEvents = 'none';
          dragGhost.style.zIndex = '1000';
          dragGhost.style.transform = 'rotate(5deg)';
          document.body.appendChild(dragGhost);

          // Update ghost position
          function updateGhost(e) {
            if (dragGhost) {
              dragGhost.style.left = (e.clientX - 20) + 'px';
              dragGhost.style.top = (e.clientY - 20) + 'px';
            }
          }

          document.addEventListener('drag', updateGhost);

          // Clean up ghost after drag ends
          slot.addEventListener('dragend', function() {
            if (dragGhost) {
              document.body.removeChild(dragGhost);
              dragGhost = null;
            }
            document.removeEventListener('drag', updateGhost);
          }, { once: true });

          console.log(`[Inventory] Started dragging item from slot ${index}`);
        });

        // Drag over event
        slot.addEventListener('dragover', function(e) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';

          // Highlight drop target
          if (dropTarget) {
            dropTarget.classList.remove('drag-over');
          }
          slot.classList.add('drag-over');
          dropTarget = slot;
        });

        // Drag leave event
        slot.addEventListener('dragleave', function(e) {
          slot.classList.remove('drag-over');
        });

        // Drop event
        slot.addEventListener('drop', function(e) {
          e.preventDefault();
          slot.classList.remove('drag-over');

          const targetIndex = index;

          if (draggedItemIndex !== -1 && draggedItemIndex !== targetIndex) {
            console.log(`[Inventory] Dropped item from slot ${draggedItemIndex} to slot ${targetIndex}`);
            swapInventoryItems(draggedItemIndex, targetIndex);
          }

          draggedItem = null;
          draggedItemIndex = -1;
        });
      });

      console.log('[Inventory] Drag and drop initialized for all slots');
    };

    // Swap items between inventory slots
    window.swapInventoryItems = function(fromSlot, toSlot) {
      if (fromSlot === toSlot || fromSlot < 0 || toSlot < 0) return false;

      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.swapInventoryItems) {
          const success = gameScene.swapInventoryItems(fromSlot, toSlot);
          if (success) {
            // Refresh inventory display
            refreshInventoryDisplay();
            console.log(`[Inventory] Successfully swapped items between slots ${fromSlot} and ${toSlot}`);
            return true;
          }
        }
      }

      console.warn(`[Inventory] Failed to swap items between slots ${fromSlot} and ${toSlot}`);
      return false;
    };

    // Move item from one slot to another
    window.moveInventoryItem = function(fromSlot, toSlot) {
      if (fromSlot === toSlot || fromSlot < 0 || toSlot < 0) return false;

      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.moveInventoryItem) {
          const success = gameScene.moveInventoryItem(fromSlot, toSlot);
          if (success) {
            // Refresh inventory display
            refreshInventoryDisplay();
            console.log(`[Inventory] Successfully moved item from slot ${fromSlot} to slot ${toSlot}`);
            return true;
          }
        }
      }

      console.warn(`[Inventory] Failed to move item from slot ${fromSlot} to slot ${toSlot}`);
      return false;
    };

    // Refresh inventory display after changes
    function refreshInventoryDisplay() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.getDefaultInventory && typeof window.populateInventoryModal === 'function') {
          const inventory = gameScene.getDefaultInventory();
          const inventoryRows = gameScene.inventoryRows || 1;
          window.populateInventoryModal(inventory, inventoryRows);
        }
      }
    }

    // Get item from inventory slot
    window.getInventoryItem = function(slot) {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.getInventoryItem) {
          return gameScene.getInventoryItem(slot);
        }
      }
      return null;
    };

    // Set item in inventory slot
    window.setInventoryItem = function(slot, item) {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.setInventoryItem) {
          gameScene.setInventoryItem(slot, item);
          refreshInventoryDisplay();
        }
      }
    };

    // Remove item from inventory slot
    window.removeInventoryItem = function(slot) {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.removeInventoryItem) {
          const removedItem = gameScene.removeInventoryItem(slot);
          refreshInventoryDisplay();
          return removedItem;
        }
      }
      return null;
    };

    // Resource management functions
    window.updateResourceDisplay = function(resource, amount) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ UI —Å—Ç—Ä–æ–∫–µ
      const uiElement = document.getElementById(resource);
      if (uiElement) {
        const iconElement = uiElement.querySelector('.resource-icon');
        if (iconElement) {
          uiElement.innerHTML = `${iconElement.outerHTML} ${amount}`;
        } else {
          uiElement.textContent = `${amount}`;
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
      const inventoryElement = document.getElementById(`resource-${resource}-quantity`);
      if (inventoryElement) {
        inventoryElement.textContent = amount.toString();
      }
    };

    window.updateAllResourceDisplays = function() {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          updateResourceDisplay('food', gameScene.food);
          updateResourceDisplay('water', gameScene.water);
          updateResourceDisplay('money', gameScene.money);
          updateResourceDisplay('ammo', gameScene.ammo);
          updateResourceDisplay('wood', gameScene.wood);
          updateResourceDisplay('metal', gameScene.metal);
          updateResourceDisplay('coal', gameScene.coal);
          updateResourceDisplay('nails', gameScene.nails);
          updateResourceDisplay('paper', gameScene.paper);
          updateResourceDisplay('glass', gameScene.glass);
        }
      }
    };

    window.addResource = function(resource, amount) {
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene) {
          switch (resource) {
            case 'food':
              gameScene.addFood(amount);
              break;
            case 'water':
              gameScene.addWater(amount);
              break;
            case 'money':
              gameScene.money = Math.max(0, gameScene.money + amount);
              break;
            case 'ammo':
              gameScene.ammo = Math.max(0, gameScene.ammo + amount);
              break;
            case 'wood':
              gameScene.wood = Math.max(0, gameScene.wood + amount);
              break;
            case 'metal':
              gameScene.metal = Math.max(0, gameScene.metal + amount);
              break;
            case 'coal':
              gameScene.coal = Math.max(0, gameScene.coal + amount);
              break;
            case 'nails':
              gameScene.nails = Math.max(0, gameScene.nails + amount);
              break;
            case 'paper':
              gameScene.paper = Math.max(0, gameScene.paper + amount);
              break;
            case 'glass':
              gameScene.glass = Math.max(0, gameScene.glass + amount);
              break;
          }
          updateAllResourceDisplays();
          updateResourceUI(resource, gameScene[resource]);
        }
      }
    };

    window.updateResourceUI = function(resource, amount) {
      const element = document.getElementById(resource);
      if (element) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç, —Å–æ—Ö—Ä–∞–Ω—è—è –∏–∫–æ–Ω–∫—É
        const iconElement = element.querySelector('.resource-icon');
        if (iconElement) {
          element.innerHTML = `${iconElement.outerHTML} ${amount}`;
        } else {
          element.textContent = `${amount}`;
        }
      }

      // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
      const resourceSlot = document.getElementById(`resource-${resource}`);
      if (resourceSlot) {
        const quantityElement = resourceSlot.querySelector('.resource-quantity');
        if (quantityElement) {
          quantityElement.textContent = amount.toString();
        }
      }
    };

    // Abilities system
    let currentAbilityPoints = 100;
    let currentCategory = 'resources';
    let abilitiesData = {};
    let learnedAbilities = new Set();

    // Initialize abilities data
    function initializeAbilitiesData() {
      abilitiesData = {
        resources: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_cooking',
            name: '–ì–æ—Ç–æ–≤–∫–∞',
            description: '–ü–æ–≤–∞—Ä–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –Ω–∞ 1 –µ–¥. –±–æ–ª—å—à–µ –µ–¥—ã',
            cost: 1,
            maxLevel: 2,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üç≥'
          },
          {
            id: 'res_plumbing',
            name: '–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞',
            description: '–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç –Ω–∞ 1 –µ–¥. –±–æ–ª—å—à–µ –≤–æ–¥—ã',
            cost: 1,
            maxLevel: 2,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üîß'
          },
          {
            id: 'res_restaurant',
            name: '–†–µ—Å—Ç–æ—Ä–∞–Ω',
            description: '–í —Å—Ç–æ–ª–æ–≤–æ–π –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üçΩÔ∏è'
          },
          {
            id: 'res_brigade',
            name: '–ë—Ä–∏–≥–∞–¥–∞',
            description: '–í —Ç—É–∞–ª–µ—Ç–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 50 },
            requirements: [],
            icon: 'üöΩ'
          },
          {
            id: 'res_consultation',
            name: '–ö–æ–Ω—Å–∏–ª–∏—É–º',
            description: '–í –≥–æ—Å–ø–∏—Ç–∞–ª–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ 1 —á–µ–ª. –±–æ–ª—å—à–µ',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 650, y: 50 },
            requirements: [],
            icon: 'üè•'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_hunting',
            name: '–î–æ–±—ã—á–∞',
            description: '–û—Ö–æ—Ç–Ω–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 5% –±–æ–ª—å—à–µ –µ–¥—ã',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['res_cooking'],
            icon: 'üèπ'
          },
          {
            id: 'res_scouting',
            name: '–†–∞–∑–≤–µ–¥–∫–∞',
            description: '–†–∞–∑–≤–µ–¥—á–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –±–æ–ª—å—à–µ –¥–æ–±—ã—á–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['res_plumbing'],
            icon: 'üîç'
          },
          {
            id: 'res_science',
            name: '–ù–∞—É–∫–∞',
            description: '–£—á–µ–Ω—ã–µ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –æ–ø—ã—Ç–∞ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 425, y: 150 },
            requirements: ['res_restaurant'],
            icon: 'üî¨'
          },
          {
            id: 'res_chemistry',
            name: '–•–∏–º–∏—è',
            description: '–•–∏–º–∏–∫–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –æ–ø—ã—Ç–∞ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 575, y: 150 },
            requirements: ['res_brigade'],
            icon: 'üß™'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'res_market_economy',
            name: '–†—ã–Ω–æ—á–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏–∫–∞',
            description: '–ü—Ä–æ–¥–∞–≤—Ü—ã –ø—Ä–∏–Ω–æ—Å—è—Ç –Ω–∞ 1 –µ–¥. –¥–µ–Ω–µ–≥ –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 250 },
            requirements: ['res_hunting', 'res_scouting'],
            icon: 'üí∞'
          },
          {
            id: 'res_penicillin',
            name: '–ü–µ–Ω–∏—Ü–∏–ª–ª–∏–Ω',
            description: '–î–æ–∫—Ç–æ—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç –Ω–∞ 1 –µ–¥. –∑–¥–æ—Ä–æ–≤—å—è –±–æ–ª—å—à–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 250 },
            requirements: ['res_science', 'res_chemistry'],
            icon: 'üíä'
          }
        ],
        bunker: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_demolition',
            name: '–î–µ–º–æ–Ω—Ç–∞–∂',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Ä–∞–∑—Ä—É—à–µ–Ω–∏—é –∫–æ–º–Ω–∞—Ç',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üí•'
          },
          {
            id: 'bunk_storage',
            name: '–•—Ä–∞–Ω–∏–ª–∏—â–µ',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–°–∫–ª–∞–¥"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üì¶'
          },
          {
            id: 'bunk_elevator',
            name: '–õ–∏—Ñ—Ç',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–õ–∏—Ñ—Ç"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üõó'
          },
          {
            id: 'bunk_armory',
            name: '–û—Ä—É–∂–µ–π–Ω–∞—è',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–û—Ä—É–∂–µ–π–Ω–∞—è"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 500, y: 50 },
            requirements: [],
            icon: 'üî´'
          },
          {
            id: 'bunk_server',
            name: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–°–µ—Ä–≤–µ—Ä–Ω–∞—è"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 650, y: 50 },
            requirements: [],
            icon: 'üíª'
          },
          {
            id: 'bunk_market',
            name: '–†—ã–Ω–æ–∫',
            description: '–î–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–†—ã–Ω–æ–∫"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 800, y: 50 },
            requirements: [],
            icon: 'üè™'
          },
          {
            id: 'bunk_classroom',
            name: '–û–±—É—á–µ–Ω–∏–µ',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Å—Ç—Ä–æ–π–∫–µ "–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞"',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 950, y: 50 },
            requirements: [],
            icon: 'üìö'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_fast_building',
            name: '–ë—ã—Å—Ç—Ä–æ–µ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ',
            description: '–£—Å–∫–æ—Ä—è–µ—Ç –ø–æ—Å—Ç—Ä–æ–π–∫—É –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['bunk_demolition'],
            icon: 'üèóÔ∏è'
          },
          {
            id: 'bunk_energy_storage',
            name: '–≠–Ω–µ—Ä–≥–æ—Ö—Ä–∞–Ω–∏–ª–∏—â–µ',
            description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —á–∏—Å–ª–æ –∫–æ–º–Ω–∞—Ç, –ø–∏—Ç–∞–µ–º—ã—Ö —Å—Ç–∞–Ω—Ü–∏–µ–π –Ω–∞ 1',
            cost: 2,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['bunk_storage'],
            icon: '‚ö°'
          },
          {
            id: 'bunk_building_discount',
            name: '–°–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ',
            description: '–°–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 425, y: 150 },
            requirements: ['bunk_elevator'],
            icon: 'üí∞'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'bunk_territory_expansion',
            name: '–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏',
            description: '–£–±–∏—Ä–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—ã—Å–æ—Ç–µ –∏ —à–∏—Ä–∏–Ω–µ',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 250 },
            requirements: ['bunk_fast_building', 'bunk_energy_storage'],
            icon: 'üåç'
          }
        ],
        defense: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_banishment',
            name: '–ò–∑–≥–Ω–∞–Ω–∏–µ',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–≥–Ω–∞–Ω–∏—è –∂–∏—Ç–µ–ª–µ–π',
            cost: 1,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: 'üö™'
          },
          {
            id: 'def_armor',
            name: '–ë—Ä–æ–Ω—è',
            description: '–ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ —Å—Ç–µ–Ω +5 –µ–¥.',
            cost: 1,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 200, y: 50 },
            requirements: [],
            icon: 'üõ°Ô∏è'
          },
          {
            id: 'def_repair',
            name: '–ü–æ—á–∏–Ω–∫–∞',
            description: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è —Å—Ç–µ–Ω +1–µ–¥./—á–∞—Å',
            cost: 1,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 350, y: 50 },
            requirements: [],
            icon: 'üîß'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_damage_boost',
            name: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞',
            description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –æ—Ç –æ—Ä—É–∂–∏—è –Ω–∞ 1 –µ–¥.',
            cost: 2,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['def_armor'],
            icon: '‚öîÔ∏è'
          },
          {
            id: 'def_shotgun',
            name: '–î—Ä–æ–±–æ–≤–∏–∫',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥—Ä–æ–±–æ–≤–∏–∫',
            cost: 2,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['def_repair'],
            icon: 'üî´'
          },
          
          // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (3 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_assault_rifle',
            name: '–®—Ç—É—Ä–º',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —à—Ç—É—Ä–º–æ–≤—É—é –≤–∏–Ω—Ç–æ–≤–∫—É',
            cost: 3,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 250 },
            requirements: ['def_damage_boost', 'def_shotgun'],
            icon: 'üî´'
          },
          
          // –≠–ª–∏—Ç–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (4 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_sniper_rifle',
            name: '–°–Ω–∞–π–ø–µ—Ä',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–Ω–∞–π–ø–µ—Ä—Å–∫—É—é –≤–∏–Ω—Ç–æ–≤–∫—É',
            cost: 4,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 125, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: 'üéØ'
          },
          {
            id: 'def_execution',
            name: '–ö–∞–∑–Ω—å',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–±–∏–π—Å—Ç–≤–∞ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π',
            cost: 4,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 275, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: '‚ö∞Ô∏è'
          },
          {
            id: 'def_army',
            name: '–ê—Ä–º–∏—è',
            description: '5% –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ä–æ–Ω—ã –¥–ª—è –°–æ–ª–¥–∞—Ç',
            cost: 4,
            maxLevel: 10,
            currentLevel: 0,
            position: { x: 425, y: 350 },
            requirements: ['def_assault_rifle'],
            icon: 'üë•'
          },
          
          // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (5 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'def_masochist',
            name: '–ú–∞–∑–æ—Ö–∏—Å—Ç',
            description: '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–ø—É—Å—Ç–∏—Ç—å –≤—Ä–∞–≥–∞ –≤ –±—É–Ω–∫–µ—Ä',
            cost: 5,
            maxLevel: 1,
            currentLevel: 0,
            position: { x: 200, y: 450 },
            requirements: ['def_sniper_rifle', 'def_execution'],
            icon: 'üòà'
          },
          {
            id: 'def_misfire',
            name: '–û—Å–µ—á–∫–∞',
            description: '–®–∞–Ω—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ç—Ä–æ–Ω –ø—Ä–∏ —Å—Ç—Ä–µ–ª—å–±–µ +5%',
            cost: 5,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 350, y: 450 },
            requirements: ['def_army'],
            icon: 'üí•'
          }
        ],
        misc: [
          // –ë–∞–∑–æ–≤—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (1 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'misc_skill_points',
            name: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—á–∫–æ–≤',
            description: '–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—á–∫–æ–≤ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –Ω–∞ 1 –µ–¥.',
            cost: 1,
            maxLevel: 3,
            currentLevel: 0,
            position: { x: 50, y: 50 },
            requirements: [],
            icon: '‚≠ê'
          },
          
          // –°—Ä–µ–¥–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ (2 —É—Ä–æ–≤–µ–Ω—å)
          {
            id: 'misc_night_speed',
            name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏',
            description: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏ –Ω–∞ 5%',
            cost: 2,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 125, y: 150 },
            requirements: ['misc_skill_points'],
            icon: 'üåô'
          },
          {
            id: 'misc_day_speed',
            name: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è',
            description: '–£—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è –Ω–∞ 5%',
            cost: 2,
            maxLevel: 5,
            currentLevel: 0,
            position: { x: 275, y: 150 },
            requirements: ['misc_skill_points'],
            icon: '‚òÄÔ∏è'
          }
        ]
      };
    }

    // Abilities functions
    window.populateAbilitiesModal = function(abilities) {
      // Initialize abilities data only once
      if (Object.keys(abilitiesData).length === 0) {
        initializeAbilitiesData();
      }
      
      setupCategoryTabs();
      renderAbilityTree();
      updateAbilityPoints();
    };

    window.populateRoomSelectionModal = function(gameScene = null) {
      console.log('[HTML] populateRoomSelectionModal called with gameScene:', !!gameScene);
      
      const roomSelectionGrid = document.querySelector('.room-selection-grid');
      if (!roomSelectionGrid) return;
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ GameScene –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
      window.currentGameScene = gameScene;
      console.log('[HTML] currentGameScene set to:', !!window.currentGameScene);
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
      const abilitiesData = window.getAbilitiesData ? window.getAbilitiesData() : null;
      console.log('[HTML] Abilities data:', abilitiesData);

      // Clear existing content
      roomSelectionGrid.innerHTML = '';

      // Define available room types with their properties and ability requirements
      const availableRooms = [
        {
          id: '–°–ø–∞–ª—å–Ω—è',
          name: '–°–ø–∞–ª—å–Ω—è',
          description: '–ö–æ–º–Ω–∞—Ç–∞ –¥–ª—è —Å–Ω–∞ –∂–∏—Ç–µ–ª–µ–π. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –∏ –∑–¥–æ—Ä–æ–≤—å–µ.',
          icon: 'üõèÔ∏è',
          cost: '100 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–°—Ç–æ–ª–æ–≤–∞—è',
          name: '–°—Ç–æ–ª–æ–≤–∞—è',
          description: '–ú–µ—Å—Ç–æ –¥–ª—è –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏. –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á–∞—Å—Ç—å–µ –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üçΩÔ∏è',
          cost: '150 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–¢—É–∞–ª–µ—Ç',
          name: '–¢—É–∞–ª–µ—Ç',
          description: '–°–∞–Ω–∏—Ç–∞—Ä–Ω–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üöΩ',
          cost: '80 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–ì–æ—Å–ø–∏—Ç–∞–ª—å',
          name: '–ì–æ—Å–ø–∏—Ç–∞–ª—å',
          description: '–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ. –õ–µ—á–∏—Ç –±–æ–ª—å–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π.',
          icon: 'üè•',
          cost: '200 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –ë–∞–∑–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞, –¥–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        },
        {
          id: '–°–∫–ª–∞–¥',
          name: '–°–∫–ª–∞–¥',
          description: '–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤.',
          icon: 'üì¶',
          cost: '90 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_storage', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–•—Ä–∞–Ω–∏–ª–∏—â–µ"
          category: 'advanced'
        },
        {
          id: '–õ–∏—Ñ—Ç',
          name: '–õ–∏—Ñ—Ç',
          description: '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–∂–¥—É —ç—Ç–∞–∂–∞–º–∏.',
          icon: 'üõó',
          cost: '180 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_elevator', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–õ–∏—Ñ—Ç"
          category: 'advanced'
        },
        {
          id: '–û—Ä—É–∂–µ–π–Ω–∞—è',
          name: '–û—Ä—É–∂–µ–π–Ω–∞—è',
          description: '–•—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ä—É–∂–∏—è –∏ –±–æ–µ–ø—Ä–∏–ø–∞—Å–æ–≤.',
          icon: 'üî´',
          cost: '250 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_armory', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–û—Ä—É–∂–µ–π–Ω–∞—è"
          category: 'advanced'
        },
                  {
            id: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            name: '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
            description: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏.',
            icon: 'üíª',
            cost: '300 –º–æ–Ω–µ—Ç',
            requiredAbility: 'bunk_server', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–°–µ—Ä–≤–µ—Ä–Ω–∞—è"
            category: 'advanced'
          },
        {
          id: '–†—ã–Ω–æ–∫',
          name: '–†—ã–Ω–æ–∫',
          description: '–¢–æ—Ä–≥–æ–≤–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–±–º–µ–Ω–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏.',
          icon: 'üè™',
          cost: '220 –º–æ–Ω–µ—Ç',
          requiredAbility: 'bunk_market', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–†—ã–Ω–æ–∫"
          category: 'advanced'
        },
                  {
            id: '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
            name: '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',
            description: '–ú–µ—Å—Ç–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤.',
            icon: 'üìö',
            cost: '160 –º–æ–Ω–µ—Ç',
            requiredAbility: 'bunk_classroom', // –¢—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å "–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞"
            category: 'advanced'
          },
        {
          id: '–°—Ç–∞–Ω—Ü–∏—è',
          name: '–°—Ç–∞–Ω—Ü–∏—è',
          description: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏–µ–π –¥–æ 3 –∫–æ–º–Ω–∞—Ç.',
          icon: '‚ö°',
          cost: '400 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –î–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞)
          category: 'critical'
        },
        {
          id: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è',
          name: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è',
          description: '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏ —Å–∏—Å—Ç–µ–º.',
          icon: 'üîß',
          cost: '180 –º–æ–Ω–µ—Ç',
          requiredAbility: null, // –î–æ—Å—Ç—É–ø–Ω–∞ —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
          category: 'basic'
        }
      ];

      // Filter rooms based on learned abilities
      console.log('=== ROOM FILTERING DEBUG ===');
      console.log('Total rooms available:', availableRooms.length);
      console.log('Abilities data:', JSON.stringify(abilitiesData, null, 2));

      const filteredRooms = availableRooms.filter(room => {
        console.log(`--- Checking room: ${room.name} ---`);
        console.log(`Required ability: ${room.requiredAbility}`);

        // –ï—Å–ª–∏ –∫–æ–º–Ω–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏, –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
        if (!room.requiredAbility) {
          console.log(`‚úÖ Room ${room.name} is basic, showing`);
          return true;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑—É—á–µ–Ω–∞ –ª–∏ —Ç—Ä–µ–±—É–µ–º–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
        if (abilitiesData && abilitiesData.learnedAbilities) {
          console.log(`Learned abilities:`, abilitiesData.learnedAbilities);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö (–º–∞—Å—Å–∏–≤ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –æ–±—ä–µ–∫—Ç—ã)
          let isLearned = false;

          if (Array.isArray(abilitiesData.learnedAbilities)) {
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏
            if (typeof abilitiesData.learnedAbilities[0] === 'string') {
              isLearned = abilitiesData.learnedAbilities.includes(room.requiredAbility);
            }
            // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã
            else if (typeof abilitiesData.learnedAbilities[0] === 'object') {
              const learnedAbility = abilitiesData.learnedAbilities.find(ability =>
                ability.id === room.requiredAbility
              );
              isLearned = learnedAbility && learnedAbility.currentLevel > 0;
            }
          }

          console.log(`Looking for ability: ${room.requiredAbility}`);
          console.log(`Is learned: ${isLearned}`);

          if (isLearned) {
            console.log(`‚úÖ Room ${room.name} - ability found and learned`);
          } else {
            console.log(`‚ùå Room ${room.name} - ability not learned or not found`);
          }

          return isLearned;
        }

        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã
        console.log(`‚ö†Ô∏è No abilities data, showing room ${room.name}`);
        return true;
      });

      console.log('=== FILTERING COMPLETE ===');
      console.log(`Filtered rooms: ${filteredRooms.length}/${availableRooms.length}`);
      filteredRooms.forEach(room => console.log(`- ${room.name}`));
      
      console.log('[HTML] Available rooms:', availableRooms.length, 'Filtered rooms:', filteredRooms.length);
      
      // Helper function to get ability name by ID
      function getAbilityName(abilityId) {
        const abilityNames = {
          'bunk_storage': '–•—Ä–∞–Ω–∏–ª–∏—â–µ',
          'bunk_elevator': '–õ–∏—Ñ—Ç',
          'bunk_armory': '–û—Ä—É–∂–µ–π–Ω–∞—è',
          'bunk_server': '–°–µ—Ä–≤–µ—Ä–Ω–∞—è',
          'bunk_market': '–†—ã–Ω–æ–∫',
          'bunk_classroom': '–ö–ª–∞—Å—Å–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞'
        };
        return abilityNames[abilityId] || abilityId;
      }
      
      // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
      /*
      console.log('=== TEMPORARY DEBUG: Showing all rooms ===');
      availableRooms.forEach(room => console.log(`Room: ${room.name}, Required: ${room.requiredAbility}`));
      */

      // Use filtered rooms for now, but we can switch to availableRooms for testing
      const roomsToShow = filteredRooms; // Change to availableRooms to show all

      // Create room option elements
      roomsToShow.forEach(room => {
        const roomOption = document.createElement('div');
        roomOption.className = 'room-option';
        roomOption.dataset.roomId = room.id;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–æ–º–Ω–∞—Ç
        if (room.category === 'critical') {
          roomOption.classList.add('critical-room');
        } else if (room.category === 'advanced') {
          roomOption.classList.add('advanced-room');
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
        let isLocked = false;

        if (room.requiredAbility) {
          if (abilitiesData && abilitiesData.learnedAbilities) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ –∏–∑—É—á–µ–Ω–Ω—ã—Ö
            if (Array.isArray(abilitiesData.learnedAbilities)) {
              if (typeof abilitiesData.learnedAbilities[0] === 'string') {
                // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–æ–∫–∏
                isLocked = !abilitiesData.learnedAbilities.includes(room.requiredAbility);
              } else if (typeof abilitiesData.learnedAbilities[0] === 'object') {
                // –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—ä–µ–∫—Ç—ã
                isLocked = !abilitiesData.learnedAbilities.find(ability =>
                  ability.id === room.requiredAbility && ability.currentLevel > 0
                );
              }
            } else {
              isLocked = true; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
            }
          } else {
            isLocked = true; // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö
          }
        }

        // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –ª–æ–≥ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
        // console.log(`[HTML] Room ${room.name}, required: ${room.requiredAbility}, isLocked: ${isLocked}`);

        if (isLocked) {
          roomOption.classList.add('locked-room');
        } else {
          roomOption.classList.add('unlocked-room');
        }
        
        roomOption.innerHTML = `
          <div class="room-icon">${room.icon}</div>
          <div class="room-name">${room.name}</div>
          <div class="room-description">${room.description}</div>
          <div class="room-cost">${room.cost}</div>
          ${room.requiredAbility ? `<div class="room-requirement">–¢—Ä–µ–±—É–µ—Ç: ${getAbilityName(room.requiredAbility)}</div>` : ''}
        `;

        // Add both click and touch handlers with protection against accidental clicks
        const handleRoomSelect = (event) => {
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –Ω–µ–¥–∞–≤–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          const now = Date.now();
          const lastOpenTime = window.lastRoomModalOpenTime || 0;
          if (now - lastOpenTime < 200) { // 200–º—Å –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            console.log('[HTML] Modal just opened, ignoring room selection');
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–∫—Ä–æ–ª–ª–æ–º
          if (event.type === 'touchend' && event.changedTouches && event.changedTouches.length > 0) {
            const touch = event.changedTouches[0];
            const startX = roomOption.dataset.touchStartX;
            const startY = roomOption.dataset.touchStartY;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è –∫–∞—Å–∞–Ω–∏—è, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            if (startX && startY) {
              const dx = Math.abs(touch.clientX - parseInt(startX));
              const dy = Math.abs(touch.clientY - parseInt(startY));
              
              // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –±–æ–ª—å—à–µ 10px, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ —Å–∫—Ä–æ–ª–ª–æ–º, –∞ –Ω–µ –≤—ã–±–æ—Ä–æ–º
              if (dx > 10 || dy > 10) {
                console.log('[HTML] Scrolling detected, ignoring room selection');
                return;
              }
            }
          }
          
          // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
          event.preventDefault();
          event.stopPropagation();
          event.stopImmediatePropagation();
          
          console.log('[HTML] Room selected:', room.id, room.name);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
          if (roomOption.classList.contains('locked-room')) {
            console.log('[HTML] Room is locked, cannot select');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            alert(`–ö–æ–º–Ω–∞—Ç–∞ "${room.name}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${getAbilityName(room.requiredAbility)}`);
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–æ–º–Ω–∞—Ç–∞
          if (!roomOption.classList.contains('unlocked-room') && room.requiredAbility) {
            console.log('[HTML] Room is not unlocked, cannot select');
            alert(`–ö–æ–º–Ω–∞—Ç–∞ "${room.name}" –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${getAbilityName(room.requiredAbility)}`);
            return;
          }
          
          // Remove previous selection
          document.querySelectorAll('.room-option').forEach(opt => opt.classList.remove('selected'));
          
          // Select this room
          roomOption.classList.add('selected');
          
          // Call game scene to handle room placement
          const gameScene = window.currentGameScene;
          console.log('[HTML] Attempting to use gameScene:', !!gameScene);
          console.log('[HTML] window.currentGameScene exists:', !!window.currentGameScene);
          
          if (gameScene) {
            console.log('[HTML] GameScene found:', !!gameScene);
            console.log('[HTML] simpleBunker exists:', !!gameScene.simpleBunker);
            
            // –ü–µ—Ä–µ–¥–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã –≤ bunkerView
            if (gameScene.simpleBunker && typeof gameScene.simpleBunker.setSelectedRoomType === 'function') {
              console.log('[HTML] Calling setSelectedRoomType with:', room.id);
              gameScene.simpleBunker.setSelectedRoomType(room.id);
            } else {
              console.warn('[HTML] simpleBunker or setSelectedRoomType not available');
            }
            
            // –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            if (typeof gameScene.selectRoomTypeForPlacement === 'function') {
              console.log('[HTML] Calling selectRoomTypeForPlacement with:', room.id);
              gameScene.selectRoomTypeForPlacement(room.id);
            } else {
              console.warn('[HTML] selectRoomTypeForPlacement not available');
            }
          } else {
            console.error('[HTML] GameScene not available in currentGameScene');
            console.log('[HTML] Available window properties:', Object.keys(window).filter(k => k.includes('game')));
          }
          
          // Close the modal
          closeModal('room-selection-modal');
        };

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–ª–∏–∫–æ–≤ –∏ –∫–∞—Å–∞–Ω–∏–π
        roomOption.addEventListener('click', handleRoomSelect);
        roomOption.addEventListener('touchstart', (event) => {
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
          if (event.touches && event.touches.length > 0) {
            const touch = event.touches[0];
            roomOption.dataset.touchStartX = touch.clientX.toString();
            roomOption.dataset.touchStartY = touch.clientY.toString();
          }
        });
        roomOption.addEventListener('touchend', handleRoomSelect);

        roomSelectionGrid.appendChild(roomOption);
      });
    };

    function setupCategoryTabs() {
      const tabs = document.querySelectorAll('.category-tab');
      
      // Remove existing event listeners to prevent duplicates
      tabs.forEach(tab => {
        const newTab = tab.cloneNode(true);
        tab.parentNode.replaceChild(newTab, tab);
      });
      
      // Add new event listeners
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentCategory = tab.dataset.category;
          
          // Clear any visible tooltips before rendering
          const tooltips = document.querySelectorAll('.ability-tooltip');
          tooltips.forEach(tooltip => {
            tooltip.remove();
          });
          
          renderAbilityTree();
        });
      });
    }

    function renderAbilityTree() {
      const tree = document.getElementById('ability-tree');
      if (!tree) return;

      // Clear existing content
      tree.innerHTML = '<svg class="connection-lines" id="connection-lines"></svg>';

      // Clear any visible tooltips
      const tooltips = document.querySelectorAll('.ability-tooltip');
      tooltips.forEach(tooltip => {
        tooltip.remove();
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
      if (typeof window.updateRoomSelectionModal === 'function') {
        console.log('[HTML] Updating room selection modal after ability tree render');
        setTimeout(() => window.updateRoomSelectionModal(), 100);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–Ω–∞—Ç –≤ Phaser
      if (window.game && window.game.scene) {
        const gameScene = window.game.scene.getScene('Game');
        if (gameScene && gameScene.simpleBunker && typeof gameScene.simpleBunker.updateRemoveButtonVisibility === 'function') {
          console.log('[HTML] Updating remove button visibility after ability change');
          setTimeout(() => gameScene.simpleBunker.updateRemoveButtonVisibility(), 200);
        }
      }
      
      const connections = document.getElementById('connection-lines');
      if (!connections) return;

      const categoryAbilities = abilitiesData[currentCategory] || [];
      
      // Render ability nodes
      categoryAbilities.forEach(ability => {
        const node = createAbilityNode(ability);
        tree.appendChild(node);
      });

      // Render connection lines
      renderConnections(categoryAbilities);
    }

    function createAbilityNode(ability) {
      const node = document.createElement('div');
      node.className = 'ability-node';
      node.dataset.abilityId = ability.id;
      
      // Determine node state
      if (ability.currentLevel >= ability.maxLevel) {
        node.classList.add('maxed');
      } else if (ability.currentLevel > 0) {
        node.classList.add('learned');
      } else if (canLearnAbility(ability)) {
        node.classList.add('unlocked');
      } else {
        node.classList.add('locked');
      }

      // Set position
      node.style.left = ability.position.x + 'px';
      node.style.top = ability.position.y + 'px';

      // Set content
      const bonusText = getBonusText(ability);
      node.innerHTML = `
        <div class="name">${ability.name}</div>
        <div class="description">${ability.description}</div>
        ${bonusText ? `<div class="bonus ${ability.currentLevel > 0 ? 'current' : ''}">${bonusText}</div>` : ''}
        ${ability.currentLevel > 0 ? `<div class="level">${ability.currentLevel}</div>` : ''}
      `;

      // Add event listeners
      node.addEventListener('click', () => handleAbilityClick(ability));
      node.addEventListener('mouseenter', (e) => showAbilityTooltip(e, ability));
      node.addEventListener('mouseleave', hideAbilityTooltip);

      return node;
    }

    function renderConnections(abilities) {
      const connections = document.getElementById('connection-lines');
      
      abilities.forEach(ability => {
        ability.requirements.forEach(reqId => {
          const reqAbility = abilities.find(a => a.id === reqId);
          if (reqAbility) {
            const line = createConnectionLine(ability, reqAbility);
            connections.appendChild(line);
          }
        });
      });
    }

    function createConnectionLine(from, to) {
      const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      const fromX = from.position.x + 60; // Center of the node (120px width / 2)
      const fromY = from.position.y + 40; // Center of the node (80px height / 2)
      const toX = to.position.x + 60;
      const toY = to.position.y + 40;

      line.setAttribute('x1', fromX);
      line.setAttribute('y1', fromY);
      line.setAttribute('x2', toX);
      line.setAttribute('y2', toY);
      line.setAttribute('class', 'connection-line');

      // Determine line state
      if (from.currentLevel > 0 && to.currentLevel > 0) {
        line.classList.add('learned');
      } else if (canLearnAbility(from) && canLearnAbility(to)) {
        line.classList.add('unlocked');
      }

      return line;
    }

    function canLearnAbility(ability) {
      // Check if all requirements are met
      const requirementsMet = ability.requirements.every(reqId => {
        const reqAbility = findAbilityById(reqId);
        return reqAbility && reqAbility.currentLevel > 0;
      });

      // Check if we have enough points
      const canAfford = currentAbilityPoints >= ability.cost;

      // Check if not maxed out
      const notMaxed = ability.currentLevel < ability.maxLevel;

      return requirementsMet && canAfford && notMaxed;
    }

    function findAbilityById(id) {
      for (const category of Object.values(abilitiesData)) {
        const ability = category.find(a => a.id === id);
        if (ability) return ability;
      }
      return null;
    }

    function getBonusText(ability) {
      if (ability.currentLevel === 0) return null;
      
      const totalBonus = ability.currentLevel * getAbilityBonusPerLevel(ability);
      const maxBonus = ability.maxLevel * getAbilityBonusPerLevel(ability);
      
      if (ability.maxLevel === 1) {
        return `+${totalBonus}`;
      } else {
        return `+${totalBonus}/${maxBonus}`;
      }
    }

    function getAbilityBonusPerLevel(ability) {
      // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–Ω—É—Å –∑–∞ –æ–¥–∏–Ω —É—Ä–æ–≤–µ–Ω—å —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
      switch (ability.id) {
        case 'res_cooking':
          return 1; // +1 –µ–¥–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_plumbing':
          return 1; // +1 –≤–æ–¥–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_hunting':
          return 5; // +5% –µ–¥—ã –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_scouting':
          return 5; // +5% –¥–æ–±—ã—á–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_science':
          return 1; // +1 –æ–ø—ã—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_chemistry':
          return 1; // +1 –æ–ø—ã—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_market_economy':
          return 1; // +1 –¥–µ–Ω—å–≥–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'res_penicillin':
          return 1; // +1 –∑–¥–æ—Ä–æ–≤—å–µ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –ë—É–Ω–∫–µ—Ä —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'bunk_fast_building':
          return 5; // +5% —Å–∫–æ—Ä–æ—Å—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'bunk_building_discount':
          return 5; // +5% —Å–∫–∏–¥–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'bunk_energy_storage':
          return 1; // +1 –∫–æ–º–Ω–∞—Ç–∞ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –ó–∞—â–∏—Ç–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'def_armor':
          return 5; // +5 –µ–¥. –∑–¥–æ—Ä–æ–≤—å—è —Å—Ç–µ–Ω –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_repair':
          return 1; // +1 –µ–¥./—á–∞—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_damage_boost':
          return 1; // +1 –µ–¥. —É—Ä–æ–Ω–∞ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_army':
          return 5; // +5% —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞—Ç—Ä–æ–Ω–æ–≤ –¥–ª—è —Å–æ–ª–¥–∞—Ç –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'def_misfire':
          return 5; // +5% —à–∞–Ω—Å –æ—Å–µ—á–∫–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
          
        // –†–∞–∑–Ω–æ–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
        case 'misc_skill_points':
          return 1; // +1 –æ—á–∫–æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'misc_night_speed':
          return 5; // +5% —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–æ—á–∏ –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        case 'misc_day_speed':
          return 5; // +5% —É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–Ω—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å
        default:
          return 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é +1
      }
    }

    function handleAbilityClick(ability) {
      if (!canLearnAbility(ability)) {
        if (ability.currentLevel >= ability.maxLevel) {
          showToast('–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∏–∑—É—á–µ–Ω–∞!');
        } else if (ability.currentLevel > 0) {
          showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è!');
        } else {
          showToast('–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!');
        }
        return;
      }

      // Learn/upgrade ability
      currentAbilityPoints -= ability.cost;
      ability.currentLevel++;
      learnedAbilities.add(ability.id);

      // Update UI
      updateAbilityPoints();
      renderAbilityTree();

      showToast(`–ò–∑—É—á–µ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: ${ability.name} (—É—Ä–æ–≤–µ–Ω—å ${ability.currentLevel})`);
    }

    function showAbilityTooltip(event, ability) {
      const tooltip = document.createElement('div');
      tooltip.className = 'ability-tooltip';
      
      const bonusText = getBonusText(ability);
      const bonusInfo = bonusText ? `<div class="cost">–¢–µ–∫—É—â–∏–π –±–æ–Ω—É—Å: ${bonusText}</div>` : '';
      
      tooltip.innerHTML = `
        <h4>${ability.name}</h4>
        <div class="description">${ability.description}</div>
        <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: ${ability.cost} –æ—á–∫–æ–≤</div>
        <div class="cost">–£—Ä–æ–≤–µ–Ω—å: ${ability.currentLevel}/${ability.maxLevel}</div>
        ${bonusInfo}
        ${ability.requirements.length > 0 ? 
          `<div class="requirements">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: ${ability.requirements.map(id => findAbilityById(id)?.name).join(', ')}</div>` : 
          '<div class="requirements">–ë–µ–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π</div>'
        }
      `;

      // Position tooltip relative to cursor
      const rect = event.target.getBoundingClientRect();
      const tooltipWidth = 250;
      const tooltipHeight = 150;
      
      // Calculate position to ensure tooltip is visible
      let left = rect.right + 10;
      let top = rect.top - 10;
      
      // Check if tooltip would go off the right edge
      if (left + tooltipWidth > window.innerWidth) {
        left = rect.left - tooltipWidth - 10;
      }
      
      // Check if tooltip would go off the bottom edge
      if (top + tooltipHeight > window.innerHeight) {
        top = window.innerHeight - tooltipHeight - 10;
      }
      
      // Ensure tooltip doesn't go off the left or top edges
      left = Math.max(10, left);
      top = Math.max(10, top);
      
      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';

      document.body.appendChild(tooltip);
      
      // Show tooltip
      setTimeout(() => tooltip.classList.add('show'), 100);
      
      // Store reference for removal
      event.target.tooltip = tooltip;
    }

    function hideAbilityTooltip(event) {
      if (event.target.tooltip) {
        event.target.tooltip.remove();
        event.target.tooltip = null;
      }
    }

    function updateAbilityPoints() {
      const pointsElement = document.getElementById('ability-points');
      if (pointsElement) {
        pointsElement.textContent = currentAbilityPoints;
      }
    }

    function clearAbilityTree() {
      const tree = document.getElementById('ability-tree');
      if (tree) {
        tree.innerHTML = '<svg class="connection-lines" id="connection-lines"></svg>';
      }
      
      // Clear all visible tooltips
      clearAllTooltips();
    }

    function clearAllTooltips() {
      const tooltips = document.querySelectorAll('.ability-tooltip');
      tooltips.forEach(tooltip => {
        tooltip.remove();
      });
    }

    function showToast(message) {
      // Simple toast implementation
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--bunker-gold);
        color: var(--bunker-bg);
        padding: 10px 15px;
        border-radius: 4px;
        z-index: 10000;
        font-size: 12px;
        max-width: 300px;
      `;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Phaser)
    window.getAbilitiesData = function() {
      return {
        currentPoints: currentAbilityPoints,
        learnedAbilities: Array.from(learnedAbilities),
        abilitiesData: abilitiesData
      };
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è—Ö (–¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Phaser)
    window.setAbilitiesData = function(data) {
      if (data.currentPoints !== undefined) {
        currentAbilityPoints = data.currentPoints;
      }
      if (data.learnedAbilities) {
        learnedAbilities = new Set(data.learnedAbilities);
      }
      if (data.abilitiesData) {
        abilitiesData = data.abilitiesData;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      updateAbilityPoints();
      renderAbilityTree();
    };

    // Universal resource click handler
    window.handleResourceClick = function(resourceType) {
      console.log('Resource clicked:', resourceType);

      // Add visual feedback
      const clickedElement = event?.target;
      if (clickedElement) {
        clickedElement.style.transform = 'scale(0.95)';
        setTimeout(() => {
          clickedElement.style.transform = '';
        }, 100);
      }

      if (resourceType === 'residents') {
        window.openResidents();
      } else if (resourceType === 'enemies') {
        window.openEnemies();
      } else {
        window.openResource(resourceType);
      }
    };

    // Debug functions for testing
    window.debugOpenPopulation = function() {
      console.log('Debug: Opening population modal');
      window.openResidents();
    };

    window.debugOpenHappiness = function() {
      console.log('Debug: Opening happiness modal');
      window.openResource('happiness');
    };

    window.debugOpenInventory = function() {
      console.log('Debug: Opening inventory modal');
      window.openInventory();
    };

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –≤–∏–¥–∞–º–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞—Å–µ–ª–µ–Ω–∏—è
    window.showResidentDetail = function() {
      console.log('[showResidentDetail] Switching to resident detail view');
      
      // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∏—Ç–µ–ª–µ–π
      const listView = document.getElementById('population-list-view');
      if (listView) {
        listView.style.display = 'none';
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∂–∏—Ç–µ–ª—è
      const detailView = document.getElementById('resident-detail-view');
      if (detailView) {
        detailView.style.display = 'block';
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
          detailView.classList.add('active');
        }, 10);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      const title = document.getElementById('population-modal-title');
      if (title) {
        title.textContent = '–ü–û–î–†–û–ë–ù–û–°–¢–ò –û –ñ–ò–¢–ï–õ–ï';
      }
    };

    window.showPopulationList = function() {
      console.log('[showPopulationList] Switching back to population list view');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –∂–∏—Ç–µ–ª—è
      const detailView = document.getElementById('resident-detail-view');
      if (detailView) {
        detailView.classList.remove('active');
        setTimeout(() => {
          detailView.style.display = 'none';
        }, 300); // –ñ–¥–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∂–∏—Ç–µ–ª–µ–π
      const listView = document.getElementById('population-list-view');
      if (listView) {
        listView.style.display = 'block';
      }
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const title = document.getElementById('population-modal-title');
      if (title) {
        title.textContent = '–†–ï–ï–°–¢–† –í–´–ñ–ò–í–®–ò–•';
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —Å–∫—Ä—ã—Ç—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ
    window.revealHiddenSkill = function(element, skillIndex) {
      console.log(`[revealHiddenSkill] Revealing skill at index: ${skillIndex}`);
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∂–∏—Ç–µ–ª–µ
      const resident = window.currentResidentsData ? window.currentResidentsData[window.currentResidentIndex] : null;
      if (!resident || !resident.skills || !resident.skills[skillIndex]) {
        console.warn('[revealHiddenSkill] Resident or skill data not available');
        return;
      }
      
      const skill = resident.skills[skillIndex];
      console.log(`[revealHiddenSkill] Skill data:`, skill);
      
      // –†–∞—Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞–≤—ã–∫ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–∫—Ä–∞—à–∏–≤–∞–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
      element.classList.remove('hidden-skill');
      element.classList.add(skill.positive ? 'positive' : 'negative');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
      const skillText = element.querySelector('.skill-text');
      const skillEffect = element.querySelector('.skill-effect');
      
      if (skillText) {
        skillText.textContent = skill.text;
      }
      
      if (skillEffect) {
        skillEffect.textContent = skill.positive ? '‚úì' : '‚úó';
      }
      
      // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞, —Ç–∞–∫ –∫–∞–∫ –Ω–∞–≤—ã–∫ —É–∂–µ —Ä–∞—Å–∫—Ä—ã—Ç
      element.onclick = null;
      
      console.log(`[revealHiddenSkill] Skill "${skill.text}" revealed successfully`);
    };
  </script>

</html>


