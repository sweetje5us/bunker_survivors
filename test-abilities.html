<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест системы способностей бункера</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
        }

        .test-btn {
            background: #2a2a2a;
            border: 2px solid #555555;
            color: #e0e0e0;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 10px;
            margin: 5px;
            border-radius: 4px;
        }

        .test-btn:hover {
            background: #3a3a3a;
            border-color: #D4AF37;
        }

        .debug-info {
            background: #2a2a2a;
            border: 1px solid #444;
            padding: 15px;
            margin-top: 20px;
            font-size: 10px;
        }

        .debug-info h3 {
            color: #D4AF37;
            margin-top: 0;
        }

        .category-test {
            margin: 20px 0;
            padding: 15px;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 4px;
        }

        .category-test h4 {
            color: #D4AF37;
            margin: 0 0 10px 0;
        }
    </style>
</head>
<body>
    <h1>Тест системы способностей бункера</h1>

    <div class="category-test">
        <h4>Тестирование категорий</h4>
        <button class="test-btn" onclick="testCategory('resources')">Тест: Ресурсы</button>
        <button class="test-btn" onclick="testCategory('bunker')">Тест: Бункер</button>
        <button class="test-btn" onclick="testCategory('defense')">Тест: Защита</button>
        <button class="test-btn" onclick="testCategory('misc')">Тест: Разное</button>
    </div>

    <div class="category-test">
        <h4>Тестирование изучения способностей</h4>
        <button class="test-btn" onclick="testAbilityLearning()">Тест изучения</button>
        <button class="test-btn" onclick="testRequirements()">Тест требований</button>
        <button class="test-btn" onclick="testUpgrades()">Тест улучшений</button>
    </div>

    <div class="category-test">
        <h4>Управление</h4>
        <button class="test-btn" onclick="openAbilitiesModal()">Открыть способности</button>
        <button class="test-btn" onclick="closeAllModals()">❌ Закрыть все</button>
    </div>

    <div class="debug-info">
        <h3>Что реализовано</h3>
                 <ul>
             <li>✅ 4 категории способностей: Ресурсы, Бункер, Защита, Разное</li>
             <li>✅ Система очков способностей (по умолчанию 100)</li>
             <li>✅ Дерево способностей с позиционированием</li>
             <li>✅ Система требований между способностями</li>
             <li>✅ Многоуровневые способности (до 3 уровней)</li>
             <li>✅ Визуальные состояния: заблокировано, разблокировано, изучено, максимум</li>
             <li>✅ Подсказки при наведении</li>
             <li>✅ Соединительные линии между связанными способностями</li>
             <li>✅ Система изучения и улучшения способностей</li>
             <li>✅ <strong>НОВОЕ:</strong> Названия и описания способностей вместо эмоджи</li>
             <li>✅ <strong>НОВОЕ:</strong> Полный справочник способностей категории "Ресурсы"</li>
             <li>✅ <strong>НОВОЕ:</strong> Полный справочник способностей категории "Бункер" (11 способностей)</li>
             <li>✅ <strong>НОВОЕ:</strong> Полный справочник способностей категории "Защита" (11 способностей)</li>
             <li>✅ <strong>НОВОЕ:</strong> Полный справочник способностей категории "Разное" (3 способности)</li>
             <li>✅ <strong>НОВОЕ:</strong> Логическая иерархия по силе и требованиям</li>
             <li>✅ <strong>НОВОЕ:</strong> Функции синхронизации с Phaser</li>
             <li>✅ <strong>НОВОЕ:</strong> Отображение суммарного бонуса для каждой способности</li>
             <li>✅ <strong>НОВОЕ:</strong> Полностью прокачанные способности имеют темный фон с контрастными цветами</li>
             <li>✅ <strong>ИСПРАВЛЕНО:</strong> Дерево способностей очищается при закрытии модального окна</li>
             <li>✅ <strong>ИСПРАВЛЕНО:</strong> Состояние прокачанных способностей сохраняется при повторном открытии</li>
             <li>✅ <strong>ИСПРАВЛЕНО:</strong> Подсказки способностей очищаются при закрытии и переключении категорий</li>
             <li>✅ <strong>ИСПРАВЛЕНО:</strong> Подсказки отображаются поверх модального окна с правильным z-index</li>
         </ul>
        <div id="status">Status: Ready</div>
    </div>

    <!-- Include the UI overlay -->
    <div id="game-ui-overlay"></div>

    <script>
        let statusElement = document.getElementById('status');

        function updateStatus(message) {
            statusElement.textContent = 'Status: ' + message;
            console.log('[Test]', message);
        }

        function testCategory(category) {
            updateStatus('Testing category: ' + category);
            
            if (typeof window.populateAbilitiesModal === 'function') {
                // Simulate opening abilities modal
                const abilitiesModal = document.getElementById('abilities-modal');
                if (abilitiesModal) {
                    abilitiesModal.style.display = 'block';
                    
                    // Switch to category
                    const tab = document.querySelector(`[data-category="${category}"]`);
                    if (tab) {
                        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // Trigger category change
                        const event = new Event('click');
                        tab.dispatchEvent(event);
                    }
                    
                    updateStatus(category + ' category displayed successfully');
                } else {
                    updateStatus('Abilities modal not found');
                }
            } else {
                updateStatus('populateAbilitiesModal function not found');
            }
        }

        function testAbilityLearning() {
            updateStatus('Testing ability learning...');
            
            // Simulate clicking on an unlocked ability
            const unlockedNode = document.querySelector('.ability-node.unlocked');
            if (unlockedNode) {
                unlockedNode.click();
                updateStatus('Ability learning test completed');
            } else {
                updateStatus('No unlocked abilities found for testing');
            }
        }

        function testRequirements() {
            updateStatus('Testing requirements system...');
            
            // Check if requirements are working
            const lockedNode = document.querySelector('.ability-node.locked');
            if (lockedNode) {
                lockedNode.click();
                updateStatus('Requirements test completed - locked ability clicked');
            } else {
                updateStatus('No locked abilities found for testing');
            }
        }

        function testUpgrades() {
            updateStatus('Testing ability upgrades...');
            
            // Check if upgrades are working
            const learnedNode = document.querySelector('.ability-node.learned');
            if (learnedNode) {
                learnedNode.click();
                updateStatus('Upgrade test completed');
            } else {
                updateStatus('No learned abilities found for testing upgrades');
            }
        }

        function openAbilitiesModal() {
            updateStatus('Opening abilities modal...');
            
            if (typeof window.openAbilities === 'function') {
                window.openAbilities();
                updateStatus('Abilities modal opened');
            } else {
                // Fallback: show modal directly
                const modal = document.getElementById('abilities-modal');
                if (modal) {
                    modal.style.display = 'block';
                    updateStatus('Abilities modal shown directly');
                } else {
                    updateStatus('Abilities modal not found');
                }
            }
        }

        function closeAllModals() {
            const modals = ['abilities-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            updateStatus('All modals closed');
        }

        // Load UI overlay
        document.addEventListener('DOMContentLoaded', function() {
            fetch('./src/ui/game-overlay.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('game-ui-overlay').innerHTML = html;
                    updateStatus('UI overlay loaded successfully');

                    // Mock game scene for testing
                    window.game = {
                        scene: {
                            getScene: function() {
                                return {
                                    showToast: function(msg) {
                                        updateStatus('Toast: ' + msg);
                                    }
                                };
                            }
                        }
                    };

                    // Initialize abilities
                    setTimeout(() => {
                        if (typeof window.populateAbilitiesModal === 'function') {
                            window.populateAbilitiesModal();
                            updateStatus('Abilities system initialized');
                        } else {
                            updateStatus('Abilities system not found');
                        }
                    }, 500);
                })
                .catch(error => {
                    updateStatus('Failed to load UI overlay: ' + error.message);
                });
        });

        console.log('Abilities system test page loaded');
    </script>
</body>
</html>
